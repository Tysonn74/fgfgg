<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiTWFkZSBGb3IgUnV0aHZlaWthIiwic2hvcnRfbmFtZSI6IlJ1dGh2ZWlrYSIsImRpc3BsYXkiOiJmdWxsc2NyZWVuIiwib3JpZW50YXRpb24iOiJsYW5kc2NhcGUiLCJ0aGVtZV9jb2xvciI6IiM0ZjQ2ZTUifQ==" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶Å</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <title>Made For Ruthveika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            animation: {
              'bounce': 'bounce 1s infinite',
              'in': 'zoomIn 0.3s ease-out',
              'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
              'pop': 'pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
            },
            keyframes: {
              zoomIn: {
                '0%': { opacity: '0', transform: 'scale(0.8)' },
                '100%': { opacity: '1', transform: 'scale(1)' },
              },
              shake: {
                '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
              },
              pop: {
                '0%': { opacity: '0', transform: 'scale(0.5)' },
                '100%': { opacity: '1', transform: 'scale(1)' }
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        overscroll-behavior: none;
        touch-action: pan-y;
        user-select: none;
        -webkit-user-select: none;
      }
      .touch-none {
        touch-action: none;
      }
      /* Custom scrollbar for history */
      .history-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .history-scroll::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Error Handler UI -->
    <div id="error-boundary" style="display: none; padding: 20px; background: #fee2e2; color: #991b1b; height: 100vh; font-family: sans-serif;">
        <h2 style="font-weight: bold; font-size: 1.5rem; margin-bottom: 10px;">Something went wrong ü¶Å</h2>
        <p>Please refresh the page. If this persists, the storage might be full.</p>
        <button onclick="localStorage.clear(); window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: bold;">Reset App Data</button>
        <pre id="error-msg" style="margin-top: 20px; font-size: 0.8rem; overflow: auto;"></pre>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-boundary').style.display = 'block';
            document.getElementById('error-msg').textContent = message + '\nAt: ' + source + ':' + lineno;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
          Play, Star, Settings, Plus, Trash2, Home, 
          ArrowRight, Eraser, Volume2, Award, Save, Check,
          Sparkles, RotateCcw, X, Languages, Type, Square, CheckSquare,
          Repeat, Music, BookOpen, Camera, Keyboard, GraduationCap, History, NotebookText, Lock, Crown
        } from 'https://esm.sh/lucide-react@0.330.0';

        /* -------------------------------------------------------------------------- */
        /* UTILITIES & DATA                            */
        /* -------------------------------------------------------------------------- */

        const SOUNDS = {
          success: 'https://codeskulptor-demos.commondatastorage.googleapis.com/show/sound2.mp3', 
          error: 'https://codeskulptor-demos.commondatastorage.googleapis.com/assets/sound/dog_bark.mp3',
          pop: 'https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3',
          complete: 'https://codeskulptor-demos.commondatastorage.googleapis.com/week7-brrring.m4a',
          select: 'https://codeskulptor-demos.commondatastorage.googleapis.com/assets/sound/click.m4a',
          unlock: 'https://codeskulptor-demos.commondatastorage.googleapis.com/assets/sound/reward.mp3',
        };

        const playSound = (type) => {
          try { const audio = new Audio(SOUNDS[type]); audio.volume = type === 'error' ? 0.3 : 0.6; audio.play().catch(e => {}); } catch (e) {}
        };

        const BASE_PHONICS = { '‡§ï': 'k', '‡§ñ': 'kh', '‡§ó': 'g', '‡§ò': 'gh', '‡§ô': 'ng', '‡§ö': 'ch', '‡§õ': 'chh', '‡§ú': 'j', '‡§ù': 'jh', '‡§û': 'ny', '‡§ü': 't', '‡§†': 'th', '‡§°': 'd', '‡§¢': 'dh', '‡§£': 'n', '‡§§': 't', '‡§•': 'th', '‡§¶': 'd', '‡§ß': 'dh', '‡§®': 'n', '‡§™': 'p', '‡§´': 'ph', '‡§¨': 'b', '‡§≠': 'bh', '‡§Æ': 'm', '‡§Ø': 'y', '‡§∞': 'r', '‡§≤': 'l', '‡§µ': 'v', '‡§∂': 'sh', '‡§∑': 'sh', '‡§∏': 's', '‡§π': 'h', '‡§ï‡•ç‡§∑': 'ksh', '‡§§‡•ç‡§∞': 'tr', '‡§ú‡•ç‡§û': 'gy', '‡§Ö': 'a', '‡§Ü': 'aa', '‡§á': 'i', '‡§à': 'ee', '‡§â': 'u', '‡§ä': 'oo', '‡§è': 'e', '‡§ê': 'ai', '‡§ì': 'o', '‡§î': 'au', '‡§Ö‡™Ç': 'an', '‡§Ö‡§É': 'ah', '‡§ã': 'ri' };
        const MATRA_PHONICS = { '‡§æ': 'aa', '‡§ø': 'i', '‡•Ä': 'ee', '‡•Å': 'u', '‡•Ç': 'oo', '‡•á': 'e', '‡•à': 'ai', '‡•ã': 'o', '‡•å': 'au', '‡§Ç': 'n', '‡§É': 'ah', '‡•É': 'ri', '‡•ç': '' };

        const getPhonetic = (grapheme) => {
          if (!grapheme) return '';
          if (BASE_PHONICS[grapheme]) return BASE_PHONICS[grapheme] + 'a';
          if (grapheme.length === 1 && BASE_PHONICS[grapheme] === undefined) return '';
          let sound = ''; let chars = Array.from(grapheme); let baseChar = chars[0];
          if (BASE_PHONICS[baseChar]) {
            sound += BASE_PHONICS[baseChar];
            let hasMatra = false;
            for (let i = 1; i < chars.length; i++) { if (MATRA_PHONICS[chars[i]] !== undefined) { sound += MATRA_PHONICS[chars[i]]; hasMatra = true; } }
            if (!hasMatra) sound += 'a';
          } else { sound = BASE_PHONICS[baseChar] || ''; }
          return sound;
        };

        const getGraphemes = (text) => {
          if (!text) return [];
          try { if (typeof Intl !== 'undefined' && Intl.Segmenter) { const segmenter = new Intl.Segmenter('hi-IN', { granularity: 'grapheme' }); return [...segmenter.segment(text)].map(s => s.segment); } } catch (e) {}
          return Array.from(text);
        };

        const RAW_DATA = [
          { en: 'Cow', hi: '‡§ó‡§æ‡§Ø', tr: 'Gaay', img: 'üêÆ' }, { en: 'Tiger', hi: '‡§¨‡§æ‡§ò', tr: 'Baagh', img: 'üêØ' }, { en: 'Grass', hi: '‡§ò‡§æ‡§∏', tr: 'Ghaas', img: 'üåø' }, { en: 'Soft', hi: '‡§®‡§∞‡§Æ', tr: 'Naram', img: '‚òÅÔ∏è' },
          { en: 'Salt', hi: '‡§®‡§Æ‡§ï', tr: 'Namak', img: 'üßÇ' }, { en: 'Hot', hi: '‡§ó‡§∞‡§Æ', tr: 'Garam', img: '‚òï' }, { en: 'Help', hi: '‡§Æ‡§¶‡§¶', tr: 'Madad', img: 'ü§ù' }, { en: 'Honey', hi: '‡§∂‡§π‡§¶', tr: 'Shahad', img: 'üçØ' },
          { en: 'City', hi: '‡§∂‡§π‡§∞', tr: 'Shahar', img: 'üèôÔ∏è' }, { en: 'Ginger', hi: '‡§Ö‡§¶‡§∞‡§ï', tr: 'Adrak', img: 'ü´ö' }, { en: 'Coat', hi: '‡§Ö‡§ö‡§ï‡§®', tr: 'Achkan', img: 'üß•' }, { en: 'Vessels', hi: '‡§¨‡§∞‡§§‡§®', tr: 'Bartan', img: 'ü•£' },
          { en: 'Banyan', hi: '‡§¨‡§∞‡§ó‡§¶', tr: 'Bargad', img: 'üå≥' }, { en: 'Neck', hi: '‡§ó‡§∞‡§¶‡§®', tr: 'Gardan', img: 'üß£' }, { en: 'Exercise', hi: '‡§ï‡§∏‡§∞‡§§', tr: 'Kasrat', img: 'üèãÔ∏è' }, { en: 'Talk', hi: '‡§¨‡§æ‡§§', tr: 'Baat', img: 'üó£Ô∏è' },
          { en: 'Brother', hi: '‡§≠‡§æ‡§à', tr: 'Bhai', img: 'üë¶' }, { en: 'Year', hi: '‡§∏‡§æ‡§≤', tr: 'Saal', img: 'üìÖ' }, { en: 'Boat', hi: '‡§®‡§æ‡§µ', tr: 'Naav', img: '‚õµ' }, { en: 'Lesson', hi: '‡§™‡§æ‡§†', tr: 'Paath', img: 'üìñ' },
          { en: 'Black', hi: '‡§ï‡§æ‡§≤‡§æ', tr: 'Kaala', img: '‚¨õ' }, { en: 'Garland', hi: '‡§Æ‡§æ‡§≤‡§æ', tr: 'Maala', img: 'üèµÔ∏è' }, { en: 'Lock', hi: '‡§§‡§æ‡§≤‡§æ', tr: 'Taala', img: 'üîí' }, { en: 'Mother', hi: '‡§Æ‡§æ‡§§‡§æ', tr: 'Maata', img: 'üë©' },
          { en: 'Uncle', hi: '‡§Æ‡§æ‡§Æ‡§æ', tr: 'Mama', img: 'üë®' }, { en: 'Star', hi: '‡§§‡§æ‡§∞‡§æ', tr: 'Taara', img: '‚≠ê' }, { en: 'Grains', hi: '‡§¶‡§æ‡§®‡§æ', tr: 'Daana', img: 'üåæ' }, { en: 'Pomegranate', hi: '‡§Ö‡§®‡§æ‡§∞', tr: 'Anaar', img: 'üçé' },
          { en: 'Carrot', hi: '‡§ó‡§æ‡§ú‡§∞', tr: 'Gaajar', img: 'ü•ï' }, { en: 'Ship', hi: '‡§ú‡§π‡§æ‡§ú', tr: 'Jahaaz', img: 'üö¢' }, { en: 'Food', hi: '‡§ñ‡§æ‡§®‡§æ', tr: 'Khaana', img: 'ü•ò' }, { en: 'Song', hi: '‡§ó‡§æ‡§®‡§æ', tr: 'Gaana', img: 'üéµ' },
          { en: 'Pond', hi: '‡§§‡§æ‡§≤‡§æ‡§¨', tr: 'Taalaab', img: 'üíß' }, { en: 'Sky', hi: '‡§Ü‡§ï‡§æ‡§∂', tr: 'Aakaash', img: '‚òÅÔ∏è' }, { en: 'Market', hi: '‡§¨‡§æ‡§ú‡§æ‡§∞', tr: 'Baazaar', img: 'üè™' }, { en: 'Tomato', hi: '‡§ü‡§Æ‡§æ‡§ü‡§∞', tr: 'Tamaatar', img: 'üçÖ' },
          { en: 'Ocean', hi: '‡§∏‡§æ‡§ó‡§∞', tr: 'Saagar', img: 'üåä' }, { en: 'House', hi: '‡§Æ‡§ï‡§æ‡§®', tr: 'Makaan', img: 'üè†' }
        ];

        const generateDefaults = () => {
          const defaults = []; let idCounter = 1;
          RAW_DATA.forEach(w => { defaults.push({ id: `dual_${idCounter}`, word_en: w.en, word_hi: w.hi, transliteration: w.tr, image: w.img, mode: 'dual' }); idCounter++; });
          RAW_DATA.forEach(w => { defaults.push({ id: `eng_${idCounter}`, word_en: w.en, word_hi: w.hi, transliteration: w.tr, image: w.img, mode: 'english' }); idCounter++; });
          return defaults;
        };
        const DEFAULT_WORDS = generateDefaults();
        const SMART_DICTIONARY = {};
        RAW_DATA.forEach(w => { SMART_DICTIONARY[w.en.toLowerCase()] = { hi: w.hi, trans: w.tr, emoji: w.img }; });
        SMART_DICTIONARY['cat'] = { hi: '‡§¨‡§ø‡§≤‡•ç‡§≤‡•Ä', trans: 'Billi', emoji: 'üê±' };
        SMART_DICTIONARY['book'] = { hi: '‡§ï‡§ø‡§§‡§æ‡§¨', trans: 'Kitaab', emoji: 'üìö' };

        const triggerConfetti = () => {
          const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
          for (let i = 0; i < 50; i++) {
            const el = document.createElement('div');
            el.style.position = 'fixed'; el.style.left = Math.random() * 100 + 'vw'; el.style.top = '-10px'; el.style.width = '10px'; el.style.height = '10px';
            el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; el.style.borderRadius = '50%'; el.style.zIndex = '9999'; el.style.pointerEvents = 'none';
            el.style.transition = 'top 1s ease-in, opacity 1s ease-in'; document.body.appendChild(el); setTimeout(() => el.remove(), 1100);
          }
        };

        const speak = (text, lang = 'en-US') => {
          if (!window.speechSynthesis) return;
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = lang; utterance.rate = 0.8; utterance.pitch = 1.1;
          if (lang.includes('hi')) { const voices = window.speechSynthesis.getVoices(); const hindiVoice = voices.find(v => v.lang.includes('hi')); if (hindiVoice) utterance.voice = hindiVoice; }
          window.speechSynthesis.speak(utterance);
        };

        /* -------------------------------------------------------------------------- */
        /* COMPONENTS                                  */
        /* -------------------------------------------------------------------------- */

        const StickerNotification = ({ sticker, onClose }) => {
            useEffect(() => { playSound('unlock'); triggerConfetti(); }, []);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 animate-in">
                    <div className="bg-white p-6 rounded-3xl text-center shadow-2xl max-w-sm mx-4 transform animate-pop border-4 border-yellow-300">
                        <div className="text-sm font-bold text-yellow-500 mb-2 uppercase tracking-widest">New Sticker!</div>
                        <div className="text-8xl mb-4 animate-bounce">{sticker.emoji}</div>
                        <h3 className="text-2xl font-extrabold text-indigo-900 mb-1">{sticker.name}</h3>
                        <p className="text-gray-500 mb-6">{sticker.desc}</p>
                        <button onClick={onClose} className="px-8 py-3 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold rounded-xl shadow-lg transform transition active:scale-95">Awesome!</button>
                    </div>
                </div>
            );
        };

        // --- STICKER CATALOG (Updated: Precise Requirements) ---
        const STICKER_CATALOG = [
          // Common (Green)
          { id: 's1', name: "First Bloom", emoji: "üå∏", rarity: "common", desc: "Complete 1 word in any mode" },
          { id: 's2', name: "Little Star", emoji: "‚≠ê", rarity: "common", desc: "Complete 5 words in any mode" },
          { id: 's3', name: "Pink Heart", emoji: "üíñ", rarity: "common", desc: "Complete 15 words in any mode" },
          { id: 's4', name: "Kitty Cat", emoji: "üê±", rarity: "common", desc: "Score 25 points total" },
          
          // Rare (Blue)
          { id: 's5', name: "Pink Butterfly", emoji: "ü¶ã", rarity: "rare", desc: "Score 50 points total" },
          { id: 's6', name: "Yummy Cupcake", emoji: "üßÅ", rarity: "rare", desc: "Complete 1 test with 100%" },
          { id: 's7', name: "Ballerina", emoji: "üíÉ", rarity: "rare", desc: "Complete 20 words in any mode" },
          { id: 's8', name: "Pretty Bow", emoji: "üéÄ", rarity: "rare", desc: "Complete 50 words in any mode" },

          // Epic (Purple)
          { id: 's9', name: "Rainbow", emoji: "üåà", rarity: "epic", desc: "Score 100 points total" },
          { id: 's10', name: "Mermaid", emoji: "üßú‚Äç‚ôÄÔ∏è", rarity: "epic", desc: "Get 5 perfect test scores" },
          { id: 's11', name: "Magic Fairy", emoji: "üßö‚Äç‚ôÄÔ∏è", rarity: "epic", desc: "Complete 75 words in any mode" },
          
          // Legendary (Gold)
          { id: 's12', name: "Unicorn", emoji: "ü¶Ñ", rarity: "legendary", desc: "Get 10 perfect test scores" },
          { id: 's13', name: "Princess", emoji: "üë∏", rarity: "legendary", desc: "Get 15 perfect test scores" },
          { id: 's14', name: "Queen Crown", emoji: "üëë", rarity: "legendary", desc: "Complete 150 words in any mode" },
          { id: 's15', name: "Pink Castle", emoji: "üè∞", rarity: "legendary", desc: "Get 20 perfect test scores" }
        ];

        // 1. Session/Test Setup Component
        const SetupScreen = ({ words, mode, isTestMode, onStart, onBack }) => {
          const [selectedIds, setSelectedIds] = useState(new Set());
          const [repeats, setRepeats] = useState(3);
          const [searchTerm, setSearchTerm] = useState('');
          const [testOptions, setTestOptions] = useState({ spelling: true, mcq: true, match: true });

          const modeWords = words.filter(w => w.mode === mode);
          const displayedWords = modeWords.filter(w => w.word_en && w.word_en.toLowerCase().includes(searchTerm.toLowerCase()));

          const toggleSelection = (id) => { playSound('select'); const next = new Set(selectedIds); if (next.has(id)) next.delete(id); else next.add(id); setSelectedIds(next); };
          const toggleSelectAll = () => { playSound('select'); if (selectedIds.size === displayedWords.length) setSelectedIds(new Set()); else setSelectedIds(new Set(displayedWords.map(w => w.id))); };

          const handleStart = () => {
            if (selectedIds.size === 0) return;
            if (isTestMode && !testOptions.spelling && !testOptions.mcq && !testOptions.match) { alert("Please select at least one question type!"); return; }
            playSound('pop');
            const selectedWordsList = words.filter(w => selectedIds.has(w.id));
            if (isTestMode) { onStart(selectedWordsList, testOptions); } 
            else {
                const queue = [];
                selectedWordsList.forEach(word => { for(let i=0; i<repeats; i++) queue.push(word); });
                onStart(queue);
            }
          };

          return (
            <div className="fixed inset-0 bg-indigo-50 z-50 flex flex-col">
              <div className="flex-1 flex flex-col max-w-4xl mx-auto w-full bg-white shadow-2xl h-full relative">
                  <div className="bg-indigo-600 p-4 text-white flex-shrink-0 shadow-md z-10">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={onBack} className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition"><ArrowRight className="rotate-180" /></button>
                        <h2 className="text-xl font-bold">{isTestMode ? "Create Test" : "Start Learning"}</h2>
                        <div className="w-8"></div>
                    </div>
                    {isTestMode ? (
                        <div className="bg-indigo-700/50 p-3 rounded-xl flex flex-wrap gap-4 items-center justify-center">
                            <label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={testOptions.spelling} onChange={e => setTestOptions({...testOptions, spelling: e.target.checked})} className="w-5 h-5 accent-yellow-400" /><span className="font-bold">Spelling</span></label>
                            <label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={testOptions.mcq} onChange={e => setTestOptions({...testOptions, mcq: e.target.checked})} className="w-5 h-5 accent-yellow-400" /><span className="font-bold">Multiple Choice</span></label>
                            <label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={testOptions.match} onChange={e => setTestOptions({...testOptions, match: e.target.checked})} className="w-5 h-5 accent-yellow-400" /><span className="font-bold">Match The Following</span></label>
                        </div>
                    ) : (
                        <div className="bg-indigo-700/50 p-2 rounded-xl flex items-center justify-between">
                            <div className="flex items-center gap-2"><Repeat size={18} className="text-indigo-200" /><span className="font-medium text-sm text-indigo-100">Repeats:</span></div>
                            <div className="flex gap-2">{[1, 3, 5, 10].map(num => (<button key={num} onClick={() => { playSound('select'); setRepeats(num); }} className={`w-8 h-8 rounded-lg font-bold text-sm transition-all ${repeats === num ? 'bg-white text-indigo-600 scale-110 shadow' : 'bg-indigo-800/50 text-indigo-300 hover:bg-indigo-800'}`}>{num}</button>))}</div>
                        </div>
                    )}
                  </div>
                  <div className="p-3 border-b flex items-center justify-between bg-gray-50 flex-shrink-0 shadow-sm z-10">
                      <button onClick={toggleSelectAll} className="flex items-center gap-2 text-indigo-600 font-bold hover:bg-indigo-100 px-3 py-2 rounded-lg transition">{selectedIds.size === displayedWords.length && displayedWords.length > 0 ? <CheckSquare size={20} /> : <Square size={20} />}<span>{selectedIds.size === displayedWords.length ? 'Deselect All' : 'Select All'}</span></button>
                      <div className="text-sm text-gray-500 font-medium bg-white px-3 py-1 rounded-full border">{selectedIds.size} Selected</div>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-32">
                    {displayedWords.length === 0 ? <div className="text-center py-10 text-gray-400">No words found</div> : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {displayedWords.map(word => (
                                <div key={word.id} onClick={() => toggleSelection(word.id)} className={`flex items-center p-3 rounded-xl border-2 transition-all cursor-pointer select-none active:scale-98 ${selectedIds.has(word.id) ? 'border-green-500 bg-green-50' : 'border-gray-100 bg-white'}`}>
                                    <div className={`w-6 h-6 rounded border mr-4 flex-shrink-0 flex items-center justify-center transition-colors ${selectedIds.has(word.id) ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300'}`}>{selectedIds.has(word.id) && <Check size={14} className="text-white" />}</div>
                                    <span className="text-4xl mr-4">{word.image}</span>
                                    <div><div className="font-bold text-gray-800 text-lg">{word.word_en}</div>{mode === 'dual' && <div className="text-sm text-gray-500 font-medium">{word.word_hi}</div>}</div>
                                </div>
                            ))}
                        </div>
                    )}
                  </div>
                  <div className="p-4 border-t bg-white flex-shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] absolute bottom-0 w-full max-w-4xl left-0 right-0 mx-auto">
                      <button onClick={handleStart} disabled={selectedIds.size === 0} className={`w-full py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-2 transition-all shadow-lg ${selectedIds.size > 0 ? 'bg-green-500 text-white hover:bg-green-600 active:scale-95' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}><Play fill="currentColor" /> {isTestMode ? "Start Test" : "Let's Go!"}</button>
                  </div>
              </div>
            </div>
          );
        };

        // 2. Typing Game Component
        const TypingGame = ({ word, onComplete, onTeachAgain }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState(false);
            const [wrongAttempts, setWrongAttempts] = useState(0);
            const inputRef = useRef(null);
            useEffect(() => { if (inputRef.current) inputRef.current.focus(); }, []);
            const checkInput = () => {
                if (input.trim().toLowerCase() === word.word_en.toLowerCase()) {
                    playSound('success'); triggerConfetti(); speak("Correct! " + word.word_en); setTimeout(onComplete, 1500);
                } else { 
                    const newAttempts = wrongAttempts + 1;
                    setWrongAttempts(newAttempts);
                    playSound('error'); setError(true); 
                    if (newAttempts >= 3 && onTeachAgain) {
                        speak("Let's practice this one again!");
                        setTimeout(onTeachAgain, 1000);
                    } else {
                        speak("Try again"); setTimeout(() => setError(false), 500); 
                    }
                }
            };
            return (
                <div className="flex flex-col items-center justify-center p-6 w-full max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold text-gray-600 mb-6">Type the word</h2>
                    <div className="text-8xl mb-8 animate-bounce">{word.image}</div>
                    <input ref={inputRef} type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && checkInput()} className={`w-full p-4 text-3xl text-center font-bold border-4 rounded-2xl outline-none transition-all ${error ? 'border-red-500 bg-red-50 animate-shake' : 'border-indigo-200 focus:border-indigo-500'}`} placeholder="..." autoComplete="off" />
                    <button onClick={checkInput} className="mt-6 w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-xl hover:bg-indigo-700 shadow-lg">Check</button>
                </div>
            );
        };

        // 3. Test Runner
        const TestRunner = ({ questions, saveHistory, onFinish }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [selectedOption, setSelectedOption] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [mistakeMade, setMistakeMade] = useState(false); 

            const currentQ = questions[currentIndex];

            const handleAnswer = (isCorrect) => {
                if (feedback) return; 
                
                if (isCorrect) {
                    setFeedback('correct');
                    playSound('success');
                    if (!mistakeMade) setScore(prev => prev + 1);
                } else {
                    setFeedback('wrong');
                    playSound('error');
                    setMistakeMade(true); 
                }

                setTimeout(() => {
                    setFeedback(null); setSelectedOption(null); setMistakeMade(false);
                    if (currentIndex + 1 < questions.length) { setCurrentIndex(prev => prev + 1); } 
                    else { 
                        const finalScore = score + (isCorrect && !mistakeMade ? 1 : 0);
                        setShowResult(true); playSound('complete'); triggerConfetti(); 
                        saveHistory(finalScore, questions.length, questions); 
                    }
                }, 1500);
            };

            if (showResult) {
                const percentage = Math.round((score / questions.length) * 100);
                return (
                    <div className="flex flex-col items-center justify-center min-h-[60vh] p-6 text-center">
                        <div className="text-6xl mb-4">{percentage >= 80 ? 'üèÜ' : percentage >= 50 ? '‚≠ê' : 'üå±'}</div>
                        <h2 className="text-4xl font-extrabold text-indigo-800 mb-2">Test Complete!</h2>
                        <p className="text-2xl text-gray-600 mb-8">You scored {score} out of {questions.length}</p>
                        <button onClick={onFinish} className="px-8 py-4 bg-green-500 text-white rounded-2xl font-bold text-xl shadow-lg hover:bg-green-600">Back Home</button>
                    </div>
                );
            }

            return (
                <div className="w-full max-w-4xl mx-auto p-4">
                    <div className="mb-6 flex justify-between items-center text-gray-500 font-bold"><span>Question {currentIndex + 1} / {questions.length}</span><span>Score: {score}</span></div>
                    {currentQ.type === 'spell_en' && (<div className="text-center"><h3 className="text-2xl mb-6 font-bold text-gray-700">Type the English spelling</h3><div className="text-8xl mb-6">{currentQ.word.image}</div><button onClick={() => speak(currentQ.word.word_en)} className="mb-6 p-3 bg-indigo-100 rounded-full"><Volume2 /></button><TypingInput correct={currentQ.word.word_en} onAnswer={handleAnswer} feedback={feedback} /></div>)}
                    {currentQ.type === 'spell_hi' && (<div className="text-center"><h3 className="text-2xl mb-6 font-bold text-gray-700">Arrange Hindi spelling</h3><div className="text-8xl mb-6">{currentQ.word.image}</div><button onClick={() => speak(currentQ.word.word_hi, 'hi-IN')} className="mb-6 p-3 bg-indigo-100 rounded-full"><Volume2 /></button><SpellingGame key={currentIndex} targetText={currentQ.word.word_hi} lang="hi" onComplete={() => handleAnswer(true)} /></div>)}
                    {(currentQ.type.startsWith('mcq')) && (<div className="text-center"><h3 className="text-2xl mb-6 font-bold text-gray-700">{currentQ.question}</h3><div className="text-6xl mb-8">{currentQ.prompt}</div><div className="grid grid-cols-2 gap-4">{currentQ.options.map((opt, i) => (<button key={i} onClick={() => { setSelectedOption(i); handleAnswer(opt === currentQ.answer); }} className={`p-6 rounded-xl text-xl font-bold border-b-4 transition-all ${feedback && opt === currentQ.answer ? 'bg-green-500 text-white border-green-700' : feedback && selectedOption === i ? 'bg-red-500 text-white border-red-700' : 'bg-white border-gray-200 hover:bg-indigo-50'}`} disabled={feedback !== null}>{opt}</button>))}</div></div>)}
                    {currentQ.type.startsWith('match') && (<div className="text-center"><h3 className="text-2xl mb-6 font-bold text-gray-700">Match the following!</h3><MatchGame pairs={currentQ.pairs} onComplete={() => handleAnswer(true)} onError={() => { playSound('error'); setMistakeMade(true); }} /></div>)}
                </div>
            );
        };

        const TypingInput = ({ correct, onAnswer, feedback }) => {
            const [val, setVal] = useState('');
            return ( <div className="flex flex-col gap-4 max-w-sm mx-auto"><input className={`p-4 border-4 rounded-xl text-center text-2xl outline-none font-bold ${feedback === 'correct' ? 'border-green-500 bg-green-50' : feedback === 'wrong' ? 'border-red-500 bg-red-50' : 'border-indigo-200'}`} value={val} onChange={e => setVal(e.target.value)} disabled={feedback !== null} /><button onClick={() => onAnswer(val.trim().toLowerCase() === correct.toLowerCase())} disabled={feedback !== null} className="p-3 bg-indigo-600 text-white rounded-xl font-bold">Submit</button></div> )
        };

        const MatchGame = ({ pairs, onComplete, onError }) => {
            const [leftSelected, setLeftSelected] = useState(null); 
            const [matched, setMatched] = useState(new Set()); 
            const [errorPair, setErrorPair] = useState({ left: null, right: null }); 
            const [leftItems] = useState(() => pairs.map(p => ({ id: p.id, val: p.left })));
            const [rightItems] = useState(() => [...pairs].sort(() => Math.random() - 0.5).map(p => ({ id: p.id, val: p.right })));

            const handleLeftClick = (id) => { if (matched.has(id)) return; setErrorPair({left:null,right:null}); setLeftSelected(id); playSound('select'); };
            const handleRightClick = (id) => {
                if (matched.has(id)) return;
                if (leftSelected === id) {
                    const newMatched = new Set(matched); newMatched.add(id); setMatched(newMatched); setLeftSelected(null); playSound('pop');
                    if (newMatched.size === pairs.length) setTimeout(onComplete, 1000);
                } else {
                    // MISTAKE LOGIC
                    onError(); 
                    setErrorPair({ left: leftSelected, right: id });
                    setTimeout(() => { setErrorPair({left:null,right:null}); setLeftSelected(null); }, 500);
                }
            };
            return (
                <div className="grid grid-cols-2 gap-8 w-full">
                    <div className="space-y-4">{leftItems.map(item => (<button key={item.id} onClick={() => handleLeftClick(item.id)} className={`w-full p-4 rounded-xl font-bold border-b-4 transition-all ${matched.has(item.id) ? 'bg-green-100 border-green-300 text-green-700 opacity-50' : errorPair.left === item.id ? 'bg-red-100 border-red-400 ring-2 ring-red-400 animate-shake' : leftSelected === item.id ? 'bg-blue-100 border-blue-400 ring-2 ring-blue-400' : 'bg-white border-gray-200'}`}>{item.val}</button>))}</div>
                    <div className="space-y-4">{rightItems.map(item => (<button key={item.id} onClick={() => handleRightClick(item.id)} className={`w-full p-4 rounded-xl font-bold border-b-4 transition-all ${matched.has(item.id) ? 'bg-green-100 border-green-300 text-green-700 opacity-50' : errorPair.right === item.id ? 'bg-red-100 border-red-400 ring-2 ring-red-400 animate-shake' : 'bg-white border-gray-200'}`}>{item.val}</button>))}</div>
                </div>
            );
        };

        const TestHistory = ({ history, onBack }) => {
            return ( <div className="min-h-screen bg-gray-50 p-4 font-sans"><div className="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden h-[90vh] flex flex-col"><header className="bg-purple-600 text-white p-4 flex items-center justify-between flex-shrink-0"><button onClick={onBack} className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition"><ArrowRight className="rotate-180" /></button><h2 className="font-bold text-lg">Test History</h2><div className="w-8"></div></header><div className="flex-1 overflow-y-auto p-4 space-y-4 history-scroll">{history.length === 0 ? <div className="text-center text-gray-400 mt-20">No tests taken yet!</div> : history.slice().reverse().map((entry, i) => (<div key={i} className="bg-white border rounded-xl p-4 shadow-sm"><div className="flex justify-between items-center mb-2"><div className="text-xs text-gray-400 font-bold">{new Date(entry.date).toLocaleDateString()} at {new Date(entry.date).toLocaleTimeString()}</div><div className={`px-3 py-1 rounded-full text-sm font-bold ${entry.score/entry.total >= 0.8 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>Score: {entry.score}/{entry.total}</div></div><div className="text-sm text-gray-600"><span className="font-bold">Words:</span> {entry.words}</div></div>))}</div></div></div> );
        };

        // --- STICKER BOARD UI ---
        const Stickers = ({ unlocked, progress, onBack }) => {
            const totalScore = progress.totalScore || 0;
            const wordsLearned = progress.completedWords.length;
            const perfectTests = progress.perfectTests || 0;
            const dualWords = progress.dualWords || 0;

            const checkUnlock = (sticker) => {
                if (unlocked.includes(sticker.id)) return true;
                // Updated Difficulty Logic based on prompt
                if (sticker.id === 's1' && wordsLearned >= 1) return true;
                if (sticker.id === 's2' && wordsLearned >= 5) return true;
                if (sticker.id === 's3' && wordsLearned >= 15) return true;
                if (sticker.id === 's4' && totalScore >= 25) return true;
                
                if (sticker.id === 's5' && totalScore >= 50) return true;
                if (sticker.id === 's6' && perfectTests >= 1) return true;
                if (sticker.id === 's7' && wordsLearned >= 20) return true;
                if (sticker.id === 's8' && wordsLearned >= 50) return true;
                
                if (sticker.id === 's9' && totalScore >= 100) return true;
                if (sticker.id === 's10' && perfectTests >= 5) return true;
                if (sticker.id === 's11' && wordsLearned >= 75) return true;
                
                if (sticker.id === 's12' && perfectTests >= 10) return true;
                if (sticker.id === 's13' && perfectTests >= 15) return true;
                if (sticker.id === 's14' && wordsLearned >= 150) return true;
                if (sticker.id === 's15' && perfectTests >= 20) return true;
                return false;
            };

            const colors = { common: 'bg-green-100 border-green-300 text-green-800', rare: 'bg-blue-100 border-blue-300 text-blue-800', epic: 'bg-purple-100 border-purple-300 text-purple-800', legendary: 'bg-yellow-100 border-yellow-300 text-yellow-800' };

            return (
                <div className="min-h-screen bg-indigo-50 p-4 font-sans">
                  <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden h-[90vh] flex flex-col">
                    <header className="bg-pink-500 text-white p-4 flex items-center justify-between flex-shrink-0 shadow-md">
                        <button onClick={onBack} className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition"><ArrowRight className="rotate-180" /></button>
                        <h2 className="font-bold text-xl flex items-center gap-2"><Crown /> Sticker Album</h2><div className="w-8"></div>
                    </header>
                    <div className="p-4 bg-pink-50 border-b border-pink-100 flex justify-between text-sm text-pink-800 font-medium">
                        <span>Words: {wordsLearned}</span><span>Score: {totalScore}</span><span>Perfects: {perfectTests}</span>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 history-scroll">
                        {STICKER_CATALOG.map(s => {
                            const isUnlocked = checkUnlock(s);
                            return (
                                <div key={s.id} className={`aspect-square rounded-2xl border-4 flex flex-col items-center justify-center p-2 text-center transition-all ${isUnlocked ? colors[s.rarity] + ' shadow-lg scale-100' : 'bg-gray-100 border-gray-200 text-gray-400 grayscale opacity-80'}`}>
                                    <div className="text-5xl mb-2">{isUnlocked ? s.emoji : <Lock size={32} />}</div>
                                    <div className="font-bold text-xs leading-tight mb-1">{s.name}</div>
                                    {!isUnlocked && <div className="text-[10px] opacity-75">{s.desc}</div>}
                                </div>
                            );
                        })}
                    </div>
                  </div>
                </div>
            );
        };

        const MemorizeGame = ({ text = "", lang, image, onComplete }) => {
          const [activeIndex, setActiveIndex] = useState(-1); const [loopCount, setLoopCount] = useState(0);
          const safeText = text || ""; const parts = lang === 'en' ? safeText.toUpperCase().split('') : getGraphemes(safeText);
          const TOTAL_LOOPS = 1; 
          useEffect(() => {
            let timeout; const runSequence = async () => {
              if (loopCount === 0 && activeIndex === -1) await new Promise(r => setTimeout(r, 500));
              if (loopCount < TOTAL_LOOPS) { for (let i = 0; i < parts.length; i++) { setActiveIndex(i); const part = parts[i]; if (lang === 'hi') speak(part, 'hi-IN'); else speak(part, 'en-US'); await new Promise(r => setTimeout(r, 1200)); } setActiveIndex(-1); await new Promise(r => setTimeout(r, 300)); speak(safeText, lang === 'hi' ? 'hi-IN' : 'en-US'); await new Promise(r => setTimeout(r, 1000)); setLoopCount(prev => prev + 1); } else { onComplete(); }
            }; runSequence(); return () => clearTimeout(timeout);
          }, [loopCount, safeText, lang]); 
          return ( <div className="flex-1 flex flex-col items-center justify-center p-6 text-center animate-in fade-in w-full"><h2 className="text-2xl font-bold text-gray-500 mb-8">Memorize: {lang === 'en' ? 'English' : 'Hindi'}</h2><div className="text-6xl mb-8">{image}</div><div className="flex flex-wrap gap-4 justify-center mb-12 w-full">{parts.map((char, idx) => (<div key={idx} className={`flex flex-col items-center justify-center p-4 rounded-xl border-4 transition-all duration-300 ${activeIndex === idx ? 'bg-yellow-100 border-yellow-400 scale-125 shadow-xl z-10' : 'bg-white border-gray-100 scale-100 opacity-50'}`} style={{ minWidth: '80px', minHeight: '100px' }}><span className="text-5xl font-bold text-gray-800">{char}</span>{lang === 'hi' && <span className={`text-lg font-bold mt-2 uppercase ${activeIndex === idx ? 'text-yellow-700' : 'text-gray-300'}`}>{getPhonetic(char)}</span>}</div>))}</div></div> );
        };

        // --- RESTORED SOLID TRACING (Letter by Letter) ---
        const SingleLetterTracer = ({ letter, onComplete }) => {
            const canvasRef = useRef(null); const [isDrawing, setIsDrawing] = useState(false); const [coverage, setCoverage] = useState(0); 
            useEffect(() => {
                const canvas = canvasRef.current; if (!canvas) return;
                const resizeAndDraw = () => {
                    const parent = canvas.parentElement; const dpr = window.devicePixelRatio || 1;
                    const size = Math.min(parent.clientWidth, parent.clientHeight, 400); 
                    canvas.width = size * dpr; canvas.height = size * dpr; canvas.style.width = `${size}px`; canvas.style.height = `${size}px`;
                    const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr); ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    
                    // Draw SOLID Guide (Mask)
                    ctx.clearRect(0,0,size,size);
                    const fontSize = size * 0.7; ctx.font = `bold ${fontSize}px Arial, sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    const x = size/2; const y = size/2 + (fontSize*0.05);
                    ctx.globalCompositeOperation = 'source-over'; 
                    ctx.fillStyle = '#e5e7eb'; // Light gray fill
                    ctx.fillText(letter, x, y); // Solid Text
                    
                    setCoverage(0);
                };
                setTimeout(resizeAndDraw, 50); window.addEventListener('resize', resizeAndDraw); return () => window.removeEventListener('resize', resizeAndDraw);
            }, [letter]);
            
            const calculateCoverage = () => {
                const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
                try {
                  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); const data = imageData.data;
                  let totalFilled = 0; let totalGuide = 0;
                  for (let i = 0; i < data.length; i += 40) { 
                      const g = data[i+1]; const a = data[i+3]; 
                      if (a > 20) { // Is part of the letter shape
                          totalGuide++; 
                          // Pink ink (low green) vs Gray background (high green)
                          if (g < 150) totalFilled++; 
                      } 
                  }
                  const percent = totalGuide > 0 ? Math.round((totalFilled/totalGuide)*100) : 0;
                  if (percent > 85) onComplete(); // Higher threshold for solid fill
                } catch (e) { onComplete(); }
            };
            const startDrawing = (e) => { 
                if(e.cancelable) e.preventDefault(); setIsDrawing(true); 
                const rect = canvasRef.current.getBoundingClientRect(); 
                const x = (e.touches?e.touches[0].clientX:e.clientX)-rect.left; 
                const y = (e.touches?e.touches[0].clientY:e.clientY)-rect.top; 
                const ctx = canvasRef.current.getContext('2d'); 
                ctx.globalCompositeOperation = 'source-atop'; // Draw ONLY inside existing pixels
                ctx.beginPath(); ctx.moveTo(x,y); 
                ctx.strokeStyle = '#ec4899'; 
                ctx.lineWidth = 45; // Thick brush for coloring
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
            };
            const draw = (e) => { 
                if(!isDrawing) return; 
                if(e.cancelable) e.preventDefault(); 
                const rect = canvasRef.current.getBoundingClientRect(); 
                const x = (e.touches?e.touches[0].clientX:e.clientX)-rect.left; 
                const y = (e.touches?e.touches[0].clientY:e.clientY)-rect.top; 
                const ctx = canvasRef.current.getContext('2d'); 
                ctx.lineTo(x,y); ctx.stroke(); 
            };
            const stopDrawing = (e) => { if(isDrawing) { if(e.cancelable) e.preventDefault(); setIsDrawing(false); canvasRef.current.getContext('2d').closePath(); calculateCoverage(); } };
            return ( <div className="relative border-4 border-dashed border-indigo-200 rounded-3xl bg-white overflow-hidden shadow-inner flex items-center justify-center"><canvas ref={canvasRef} className="cursor-crosshair touch-none" style={{ touchAction: 'none' }} onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} /></div> );
        };

        const WordTracer = ({ text, label, onComplete }) => {
            const [currentLetterIndex, setCurrentLetterIndex] = useState(0); const [key, setKey] = useState(0);
            const parts = useMemo(() => getGraphemes(text), [text]); const currentLetter = parts[currentLetterIndex];
            const handleLetterComplete = () => {
                playSound('success'); const isHindiChar = /[^\x00-\x7F]/.test(currentLetter); if (isHindiChar) speak(currentLetter, 'hi-IN'); else speak(currentLetter, 'en-US');
                if (currentLetterIndex < parts.length - 1) { setTimeout(() => { setCurrentLetterIndex(prev => prev + 1); setKey(prev => prev + 1); }, 500); } 
                else { setTimeout(() => { playSound('complete'); onComplete(); }, 800); }
            };
            return (
                <div className="flex flex-col items-center w-full h-full p-4">
                    <h3 className="text-xl font-bold text-gray-500 mb-4 uppercase tracking-wider flex-shrink-0">{label}: {currentLetterIndex + 1} / {parts.length}</h3>
                    <div className="flex gap-2 mb-6">{parts.map((p, i) => (<div key={i} className={`w-3 h-3 rounded-full transition-colors duration-300 ${i < currentLetterIndex ? 'bg-green-500' : i === currentLetterIndex ? 'bg-indigo-600 scale-125' : 'bg-gray-200'}`} />))}</div>
                    <div className="flex-1 w-full max-w-lg flex items-center justify-center"><SingleLetterTracer key={key} letter={currentLetter} onComplete={handleLetterComplete} /></div>
                    <p className="text-sm text-gray-400 mt-4 animate-pulse">Color inside the letter!</p>
                </div>
            );
        };

        const SpellingGame = ({ targetText, onComplete, lang = 'en' }) => {
          const isEnglish = /[a-zA-Z]/.test(targetText);
          const displayChars = isEnglish ? (targetText || "").toUpperCase().split('') : getGraphemes(targetText);
          const [shuffledTiles, setShuffledTiles] = useState([]);
          const [placedTiles, setPlacedTiles] = useState(Array(displayChars.length).fill(null));
          const [feedback, setFeedback] = useState(null); const [showCorrection, setShowCorrection] = useState(false);
          useEffect(() => {
            const chars = displayChars.map((char, id) => ({ char, id: `tile-${id}-${Math.random()}` }));
            for (let i = chars.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [chars[i], chars[j]] = [chars[j], chars[i]]; }
            setShuffledTiles(chars); setPlacedTiles(Array(displayChars.length).fill(null)); setFeedback(null); setShowCorrection(false);
          }, [targetText]);
          const handleTileClick = (tile, fromIndex, isFromBank) => {
            if (feedback === 'success' || showCorrection) return;
            if (isFromBank) {
              const firstEmptyIndex = placedTiles.findIndex(t => t === null);
              if (firstEmptyIndex !== -1) {
                playSound('pop'); const newPlaced = [...placedTiles]; newPlaced[firstEmptyIndex] = tile; setPlacedTiles(newPlaced); setShuffledTiles(prev => prev.filter(t => t.id !== tile.id)); speak(tile.char, lang === 'hi' ? 'hi-IN' : 'en-US');
                if (firstEmptyIndex === placedTiles.length - 1) { const spelledWord = newPlaced.map(t => t.char).join(''); if (spelledWord === displayChars.join('')) { setFeedback('success'); triggerConfetti(); playSound('success'); setTimeout(() => { speak(targetText, lang === 'hi' ? 'hi-IN' : 'en-US'); }, 500); setTimeout(onComplete, 2000); } else { setFeedback('error'); playSound('error'); setShowCorrection(true); setTimeout(() => { setPlacedTiles(Array(displayChars.length).fill(null)); setShuffledTiles(displayChars.map((char, id) => ({ char, id: `tile-${id}-${Math.random()}` })).sort(() => Math.random() - 0.5)); setFeedback(null); setShowCorrection(false); }, 2500); } }
              }
            } else { playSound('pop'); const newPlaced = [...placedTiles]; newPlaced[fromIndex] = null; setPlacedTiles(newPlaced); setShuffledTiles(prev => [...prev, tile]); setFeedback(null); }
          };
          return (
            <div className="flex flex-col items-center w-full max-w-4xl mx-auto h-full justify-center">
              {showCorrection && <div className="mb-4 p-4 bg-red-100 border-2 border-red-300 rounded-xl text-center animate-bounce"><p className="text-red-800 font-bold text-sm">Oops! The correct spelling is:</p><p className="text-3xl font-black text-red-600 tracking-widest mt-1">{displayChars.join('')}</p></div>}
              <div className="flex gap-2 mb-8 p-4 bg-indigo-50 rounded-xl shadow-inner min-h-[140px] items-center justify-center w-full flex-wrap">
                {placedTiles.map((tile, i) => ( <button key={i} onClick={() => tile && handleTileClick(tile, i, false)} className={`w-16 h-24 sm:w-24 sm:h-32 border-b-4 rounded-2xl flex flex-col items-center justify-center transition-all transform ${tile ? 'bg-white border-indigo-200 shadow-md scale-100' : 'bg-gray-100 border-gray-200 border-dashed'} ${feedback === 'error' ? 'animate-shake border-red-400 bg-red-50' : ''} ${feedback === 'success' ? 'border-green-400 bg-green-50 scale-110' : ''}`}> {tile && <><span className="text-3xl font-bold mb-1 text-indigo-900">{tile.char}</span>{lang === 'hi' && <span className="text-sm text-indigo-500 font-bold tracking-wider uppercase font-mono bg-indigo-50 px-2 rounded-lg mt-1">{getPhonetic(tile.char)}</span>}</>} </button> ))}
              </div>
              <div className="flex flex-wrap justify-center gap-3">
                {shuffledTiles.map((tile) => ( <button key={tile.id} onClick={() => handleTileClick(tile, null, true)} className="w-16 h-24 sm:w-24 sm:h-32 bg-white border-b-4 border-indigo-200 rounded-2xl shadow-sm flex flex-col items-center justify-center active:scale-95 hover:-translate-y-1 transition-transform"> <span className="text-3xl font-bold mb-1 text-indigo-900">{tile.char}</span>{lang === 'hi' && <span className="text-sm text-indigo-500 font-bold tracking-wider uppercase font-mono bg-indigo-50 px-2 rounded-lg mt-1">{getPhonetic(tile.char)}</span>} </button> ))}
              </div>
            </div>
          );
        };

        const WordRow = ({ word, isSelected, toggleSelection }) => ( <div onClick={() => toggleSelection(word.id)} className={`flex items-center p-3 border rounded-lg shadow-sm mb-2 cursor-pointer transition-all ${isSelected ? 'bg-blue-50 border-blue-400 ring-1 ring-blue-400' : 'bg-white border-gray-200 hover:bg-gray-50'}`}><div className={`w-6 h-6 rounded border mr-4 flex items-center justify-center transition-colors ${isSelected ? 'bg-blue-500 border-blue-500' : 'bg-white border-gray-300'}`}>{isSelected && <Check size={16} className="text-white" />}</div><div className="flex items-center gap-3 flex-1"><span className="text-2xl">{word.image}</span><div><div className="font-bold text-gray-800">{word.word_en}</div>{word.mode === 'dual' && <div className="text-xs text-gray-500">{word.word_hi}</div>}</div></div></div> );

        const AdminPanel = ({ words, setWords, goBack }) => {
          const [newWord, setNewWord] = useState({ id: '', word_en: '', word_hi: '', transliteration: '', image: 'üçé', mode: 'dual' });
          const [selectedIds, setSelectedIds] = useState(new Set());
          const [confirmDelete, setConfirmDelete] = useState(false);
          const toggleSelection = (id) => { const next = new Set(selectedIds); if (next.has(id)) next.delete(id); else next.add(id); setSelectedIds(next); };
          const selectAll = (mode) => { const modeWords = words.filter(w => w.mode === mode); const modeIds = modeWords.map(w => w.id); const next = new Set(selectedIds); const allSelected = modeIds.every(id => next.has(id)); if (allSelected) modeIds.forEach(id => next.delete(id)); else modeIds.forEach(id => next.add(id)); setSelectedIds(next); };
          const deleteSelected = () => { if (confirmDelete) { setWords(words.filter(w => !selectedIds.has(w.id))); setSelectedIds(new Set()); setConfirmDelete(false); playSound('pop'); } else { setConfirmDelete(true); setTimeout(() => setConfirmDelete(false), 3000); } };
          const handleEnglishChange = (e) => { const val = e.target.value; let updatedWord = { ...newWord, word_en: val }; if (SMART_DICTIONARY[val.toLowerCase().trim()]) { const info = SMART_DICTIONARY[val.toLowerCase().trim()]; updatedWord = { ...updatedWord, word_hi: info.hi, transliteration: info.trans, image: info.emoji }; } setNewWord(updatedWord); };
          const handleAdd = () => { if (!newWord.word_en) return; const word = { ...newWord, id: Date.now().toString() }; setWords([...words, word]); setNewWord({ id: '', word_en: '', word_hi: '', transliteration: '', image: 'üçé', mode: newWord.mode }); playSound('success'); };
          return (
            <div className="min-h-screen bg-gray-50 p-4 font-sans"><div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden pb-20"><header className="bg-gray-800 text-white p-4 flex items-center justify-between sticky top-0 z-10 shadow-md"><button onClick={goBack} className="hover:bg-gray-700 p-2 rounded"><ArrowRight className="rotate-180" /></button><h2 className="font-bold text-lg">Parent Dashboard</h2><div className="w-8"></div></header>{selectedIds.size > 0 && (<div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 animate-in slide-in-from-bottom-4"><button onClick={deleteSelected} className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold shadow-xl transition-all ${confirmDelete ? 'bg-red-600 text-white scale-110' : 'bg-gray-900 text-white hover:bg-black'}`}><Trash2 size={20} />{confirmDelete ? 'Tap again to Confirm' : `Delete ${selectedIds.size} Selected`}</button></div>)}<div className="p-6 space-y-8"><div className="bg-blue-50 p-6 rounded-xl border border-blue-100 relative overflow-hidden"><div className="absolute top-0 right-0 bg-yellow-200 text-yellow-800 text-xs font-bold px-2 py-1 rounded-bl-lg"><Sparkles size={12} className="inline mr-1" /> Smart Auto-Fill Active</div><h3 className="text-blue-900 font-bold mb-4 flex items-center gap-2"><Plus size={20}/> Add New Word</h3><div className="flex gap-4 mb-4"><label className="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-blue-100 transition"><input type="radio" name="wordMode" checked={newWord.mode === 'english'} onChange={() => setNewWord({...newWord, mode: 'english'})} className="w-4 h-4 text-blue-600" /><span className="font-bold text-gray-700">English Only</span></label><label className="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-blue-100 transition"><input type="radio" name="wordMode" checked={newWord.mode === 'dual'} onChange={() => setNewWord({...newWord, mode: 'dual'})} className="w-4 h-4 text-green-600" /><span className="font-bold text-gray-700">English & Hindi</span></label></div><div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div className="col-span-1 sm:col-span-2"><label className="text-xs text-blue-700 font-bold ml-1 mb-1 block">English Word</label><input placeholder="e.g. Lion" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg" value={newWord.word_en} onChange={handleEnglishChange} /></div>{newWord.mode === 'dual' && (<><input placeholder="Hindi (e.g. ‡§∏‡•á‡§¨)" className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={newWord.word_hi} onChange={e => setNewWord({...newWord, word_hi: e.target.value})} /><input placeholder="Transliteration (e.g. Seb)" className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={newWord.transliteration} onChange={e => setNewWord({...newWord, transliteration: e.target.value})} /></>)}<input placeholder="Emoji (e.g. üçé)" className={`p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-2xl text-center ${newWord.mode === 'english' ? 'col-span-2' : ''}`} value={newWord.image} onChange={e => setNewWord({...newWord, image: e.target.value})} /></div><button onClick={handleAdd} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex justify-center items-center gap-2"><Save size={20} /> Add to {newWord.mode === 'english' ? 'English' : 'Dual'} List</button></div><div className="grid grid-cols-1 md:grid-cols-2 gap-8"><div className="bg-gray-50 rounded-xl p-4 border shadow-sm"><div className="flex items-center justify-between mb-4 pb-2 border-b"><h3 className="font-bold text-blue-800 flex items-center gap-2"><Type size={18} /> English Only</h3><button onClick={() => selectAll('english')} className="text-xs text-blue-600 font-bold hover:underline">Select All</button></div><div className="space-y-2 max-h-[400px] overflow-y-auto">{words.filter(w => w.mode === 'english').map(word => <WordRow key={word.id} word={word} isSelected={selectedIds.has(word.id)} toggleSelection={toggleSelection} />)}{words.filter(w => w.mode === 'english').length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">No words yet</p>}</div></div><div className="bg-gray-50 rounded-xl p-4 border shadow-sm"><div className="flex items-center justify-between mb-4 pb-2 border-b"><h3 className="font-bold text-green-800 flex items-center gap-2"><Languages size={18} /> Dual Language</h3><button onClick={() => selectAll('dual')} className="text-xs text-green-600 font-bold hover:underline">Select All</button></div><div className="space-y-2 max-h-[400px] overflow-y-auto">{words.filter(w => w.mode === 'dual').map(word => <WordRow key={word.id} word={word} isSelected={selectedIds.has(word.id)} toggleSelection={toggleSelection} />)}{words.filter(w => w.mode === 'dual').length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">No words yet</p>}</div></div></div></div></div></div>
          );
        };

        // Main App Component
        const App = () => {
          const [words, setWords] = useState(() => { try { const saved = localStorage.getItem('spelling_bee_words'); if (saved) { const parsed = JSON.parse(saved); if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].word_en && parsed[0].mode) return parsed; } return DEFAULT_WORDS; } catch(e) { return DEFAULT_WORDS; } });
          const [progress, setProgress] = useState(() => { try { const saved = localStorage.getItem('spelling_bee_progress'); return saved ? JSON.parse(saved) : { stickers: [], completedWords: [], totalScore: 0, perfectTests: 0, dualWords: 0 }; } catch(e) { return { stickers: [], completedWords: [], totalScore: 0, perfectTests: 0, dualWords: 0 }; } });
          const [profilePic, setProfilePic] = useState(() => { try { return localStorage.getItem('lingo_kids_profile') || null; } catch(e) { return null; } });
          const [testHistory, setTestHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('lingo_kids_history')) || []; } catch(e) { return []; } });
          const [newSticker, setNewSticker] = useState(null);

          const [mode, setMode] = useState('home'); 
          const [gameMode, setGameMode] = useState('dual');
          const [playQueue, setPlayQueue] = useState([]);
          const [queueIndex, setQueueIndex] = useState(0);
          const [lessonStep, setLessonStep] = useState('card');
          const [isTestMode, setIsTestMode] = useState(false);
          const fileInputRef = useRef(null);

          useEffect(() => { try { localStorage.setItem('spelling_bee_words', JSON.stringify(words)); } catch(e) { console.error("Storage full", e); } }, [words]);
          useEffect(() => { try { localStorage.setItem('spelling_bee_progress', JSON.stringify(progress)); } catch(e) { console.error("Storage full", e); } }, [progress]);
          useEffect(() => { try { localStorage.setItem('lingo_kids_history', JSON.stringify(testHistory)); } catch(e) {} }, [testHistory]);
          useEffect(() => { if (profilePic) { try { localStorage.setItem('lingo_kids_profile', profilePic); } catch(e) {} } }, [profilePic]);

          const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { if (file.size > 1024 * 1024) { alert("Image too large!"); return; } const reader = new FileReader(); reader.onloadend = () => { setProfilePic(reader.result); }; reader.readAsDataURL(file); } };

          const currentWord = playQueue[queueIndex];

          const checkStickerUnlocks = (newProg) => {
              const unlockedNow = [];
              STICKER_CATALOG.forEach(s => {
                  if (!newProg.stickers.includes(s.id)) {
                      let unlock = false;
                      const wordsLearned = newProg.completedWords.length;
                      const totalScore = newProg.totalScore;
                      const perfectTests = newProg.perfectTests || 0;
                      const dualWords = newProg.dualWords || 0;
                      
                      if (s.id === 's1' && wordsLearned >= 1) unlock = true;
                      else if (s.id === 's2' && wordsLearned >= 5) unlock = true;
                      else if (s.id === 's3' && wordsLearned >= 15) unlock = true;
                      else if (s.id === 's4' && totalScore >= 25) unlock = true;
                      else if (s.id === 's5' && totalScore >= 50) unlock = true;
                      else if (s.id === 's6' && perfectTests >= 1) unlock = true;
                      else if (s.id === 's7' && wordsLearned >= 20) unlock = true;
                      else if (s.id === 's8' && wordsLearned >= 50) unlock = true;
                      else if (s.id === 's9' && totalScore >= 100) unlock = true;
                      else if (s.id === 's10' && perfectTests >= 5) unlock = true;
                      else if (s.id === 's11' && wordsLearned >= 75) unlock = true;
                      else if (s.id === 's12' && perfectTests >= 10) unlock = true;
                      else if (s.id === 's13' && perfectTests >= 15) unlock = true;
                      else if (s.id === 's14' && wordsLearned >= 150) unlock = true;
                      else if (s.id === 's15' && perfectTests >= 20) unlock = true;

                      if (unlock) unlockedNow.push(s.id);
                  }
              });
              
              if (unlockedNow.length > 0) {
                  const s = STICKER_CATALOG.find(st => st.id === unlockedNow[0]);
                  setNewSticker(s);
                  return { ...newProg, stickers: [...newProg.stickers, ...unlockedNow] };
              }
              return newProg;
          };

          const handleLessonComplete = () => {
            let newProgress = { 
                ...progress, 
                completedWords: [...new Set([...progress.completedWords, currentWord.id])],
                dualWords: currentWord.mode === 'dual' ? (progress.dualWords || 0) + 1 : (progress.dualWords || 0)
            };
            newProgress = checkStickerUnlocks(newProgress);
            setProgress(newProgress); 
            triggerConfetti(); playSound('complete');
            setTimeout(() => {
                if (queueIndex + 1 >= playQueue.length) { setMode('home'); speak("Session complete! Great job!", 'en-US'); } else { setLessonStep('card'); setQueueIndex(prev => prev + 1); }
            }, 2500);
          };

          const handleTestComplete = (score, total, questions) => {
              const uniqueWords = [...new Set(questions.map(q => q.word ? q.word.word_en : (q.prompt || 'Match')))].join(", ");
              const newEntry = {
                  id: Date.now(),
                  date: new Date().toISOString(),
                  score, total, words: uniqueWords, mode: gameMode
              };
              setTestHistory(prev => [newEntry, ...prev]);
              
              let newProgress = { 
                  ...progress, 
                  totalScore: (progress.totalScore || 0) + score,
                  perfectTests: score === total ? (progress.perfectTests || 0) + 1 : (progress.perfectTests || 0)
              };
              newProgress = checkStickerUnlocks(newProgress);
              setProgress(newProgress);
              setMode('home');
          };

          const startTest = (selectedWords, options) => {
              if (selectedWords.length === 0) return;
              const questions = [];
              const allWords = words; 
              if (options.spelling) { selectedWords.forEach(word => { questions.push({ type: 'spell_en', word: word }); if (word.mode === 'dual') questions.push({ type: 'spell_hi', word: word }); }); }
              if (options.mcq) {
                  selectedWords.forEach(word => {
                    if (word.mode === 'dual') {
                      const distractors = allWords.filter(w => w.id !== word.id && w.mode === 'dual').sort(() => 0.5 - Math.random()).slice(0, 3).map(w => w.word_hi);
                      while (distractors.length < 3) distractors.push("..."); 
                      const opts = [...distractors, word.word_hi].sort(() => 0.5 - Math.random());
                      questions.push({ type: 'mcq_en_hi', prompt: word.word_en, question: `What is "${word.word_en}" in Hindi?`, options: opts, answer: word.word_hi });
                      const distractorsEn = allWords.filter(w => w.id !== word.id).sort(() => 0.5 - Math.random()).slice(0, 3).map(w => w.word_en);
                      while (distractorsEn.length < 3) distractorsEn.push("...");
                      const optsEn = [...distractorsEn, word.word_en].sort(() => 0.5 - Math.random());
                      questions.push({ type: 'mcq_hi_en', prompt: word.word_hi, question: `What does "${word.word_hi}" mean?`, options: optsEn, answer: word.word_en });
                    }
                  });
              }
              if (options.match) {
                 const dualWords = selectedWords.filter(w => w.mode === 'dual');
                 for (let i = 0; i < dualWords.length; i += 5) {
                     const chunk = dualWords.slice(i, i + 5);
                     if (chunk.length >= 3) { 
                         const pairs = chunk.map(w => ({ id: w.id, left: w.word_en, right: w.word_hi }));
                         questions.push({ type: 'match_en_hi', pairs });
                     }
                 }
              }
              if (questions.length === 0) { alert("No questions generated based on selection."); return; }
              questions.sort(() => 0.5 - Math.random()); setPlayQueue(questions); setQueueIndex(0); setMode('test_running');
          };

          return (
              <>
                {newSticker && <StickerNotification sticker={newSticker} onClose={() => setNewSticker(null)} />}
                {mode === 'home' && (
                  <div className="min-h-screen bg-gradient-to-b from-blue-300 to-purple-300 p-6 flex flex-col items-center justify-center font-sans">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center space-y-6 transform hover:scale-[1.02] transition-transform">
                      <div className="mb-4"><h1 className="text-3xl font-extrabold text-indigo-600 tracking-tight drop-shadow-sm">Made For</h1><h1 className="text-4xl font-extrabold text-pink-500 tracking-tight drop-shadow-sm">Ruthveika</h1></div>
                      <div className="relative mx-auto w-40 h-40 cursor-pointer group" onClick={() => fileInputRef.current.click()}>
                        <div className="w-full h-full rounded-full border-4 border-indigo-200 overflow-hidden shadow-lg bg-indigo-50 flex items-center justify-center">{profilePic ? (<img src={profilePic} alt="Profile" className="w-full h-full object-cover" />) : (<div className="text-6xl animate-bounce">ü¶Å</div>)}</div>
                        <div className="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full shadow-md transition-transform transform group-hover:scale-110"><Camera size={20} /></div>
                        <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                      </div>
                      <div className="space-y-3 w-full mt-6">
                        <button onClick={() => { playSound('pop'); setGameMode('english'); setIsTestMode(false); setMode('setup'); }} className="w-full py-4 bg-blue-500 border-b-8 border-blue-700 rounded-2xl text-white text-xl font-bold hover:bg-blue-600 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-2"><Type size={24} /> English Only</button>
                        <button onClick={() => { playSound('pop'); setGameMode('dual'); setIsTestMode(false); setMode('setup'); }} className="w-full py-4 bg-green-500 border-b-8 border-green-700 rounded-2xl text-white text-xl font-bold hover:bg-green-600 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-2"><Languages size={24} /> English & Hindi</button>
                        <button onClick={() => { playSound('pop'); setIsTestMode(true); setGameMode('dual'); setMode('setup'); }} className="w-full py-4 bg-purple-500 border-b-8 border-purple-700 rounded-2xl text-white text-xl font-bold hover:bg-purple-600 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-2"><GraduationCap size={24} /> Take a Test</button>
                      </div>
                      <div className="grid grid-cols-2 gap-4 mt-4">
                        <button onClick={() => { playSound('pop'); setMode('stickers'); }} className="py-3 bg-yellow-300 border-b-4 border-yellow-500 rounded-xl text-yellow-900 font-bold hover:bg-yellow-400 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center"><Award size={24} className="mb-1"/> Stickers</button>
                        <button onClick={() => { playSound('pop'); setMode('history'); }} className="py-3 bg-teal-200 border-b-4 border-teal-400 rounded-xl text-teal-800 font-bold hover:bg-teal-300 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center"><NotebookText size={24} className="mb-1"/> History</button>
                      </div>
                      <button onClick={() => { playSound('pop'); setMode('admin'); }} className="mt-4 py-3 w-full bg-gray-200 border-b-4 border-gray-400 rounded-xl text-gray-700 font-bold hover:bg-gray-300 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center"><Settings size={24} className="mb-1"/> Parents</button>
                    </div>
                  </div>
                )}
                {mode === 'setup' && <SetupScreen words={words} mode={gameMode} isTestMode={isTestMode} onBack={() => setMode('home')} onStart={(queue, opts) => { if (isTestMode) startTest(queue, opts); else { setPlayQueue(queue); setQueueIndex(0); setLessonStep('card'); setMode('learn'); } }} />}
                {mode === 'stickers' && <Stickers unlocked={progress.stickers || []} progress={progress} onBack={() => setMode('home')} />}
                {mode === 'history' && <TestHistory history={testHistory} onBack={() => setMode('home')} />}
                {mode === 'admin' && <AdminPanel words={words} setWords={setWords} goBack={() => setMode('home')} />}
                {mode === 'test_running' && <TestRunner questions={playQueue} saveHistory={handleTestComplete} onFinish={() => setMode('home')} />}
                {mode === 'learn' && currentWord && (
                    <div className="min-h-screen bg-indigo-50 flex flex-col font-sans">
                        <div className="p-4 flex flex-col gap-2 bg-white shadow-sm z-10">
                            <div className="flex justify-between items-center"><button onClick={() => setMode('home')} className="p-2 hover:bg-gray-100 rounded-full"><Home className="text-gray-500" /></button><div className="flex gap-2"></div><div className="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-full text-yellow-800 font-bold"><Star size={16} fill="currentColor" /> {progress.stickers ? progress.stickers.length : 0}</div></div>
                            <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-green-500 transition-all duration-500 ease-out" style={{ width: `${Math.round(((queueIndex) / playQueue.length) * 100)}%` }} /></div>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center p-4">
                            <div className="w-full max-w-6xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden min-h-[600px] flex flex-col">
                                {lessonStep === 'card' && (
                                    <div key={queueIndex} className="flex-1 flex flex-col items-center justify-center p-8 text-center animate-in fade-in slide-in-from-right-8">
                                        <div className="text-9xl mb-8 transform hover:scale-110 transition-transform duration-300 cursor-pointer" onClick={() => speak(currentWord.word_en)}>{currentWord.image}</div>
                                        <div className="space-y-2 mb-8"><h2 className="text-5xl font-extrabold text-gray-800">{currentWord.word_en}</h2>{gameMode === 'dual' && currentWord.word_hi && (<div className="text-gray-500 text-xl font-medium">{currentWord.word_hi} <span className="text-gray-300">‚Ä¢</span> {currentWord.transliteration}</div>)}</div>
                                        <div className="flex gap-4"><button onClick={() => speak(currentWord.word_en)} className="p-4 bg-indigo-100 rounded-full text-indigo-600 hover:bg-indigo-200 transition-colors"><Volume2 size={32} /></button>{gameMode === 'dual' && (<button onClick={() => speak(currentWord.word_hi, 'hi-IN')} className="p-4 bg-pink-100 rounded-full text-pink-600 hover:bg-pink-200 transition-colors"><span className="font-bold text-lg">HI</span></button>)}</div>
                                        <button onClick={() => { playSound('pop'); setLessonStep('memorize_en'); }} className="mt-12 w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-xl hover:bg-indigo-700 flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">Let's Learn! <ArrowRight /></button>
                                    </div>
                                )}
                                {lessonStep === 'memorize_en' && <MemorizeGame key={queueIndex} text={currentWord.word_en} lang="en" image={currentWord.image} onComplete={() => { playSound('success'); setTimeout(() => setLessonStep('spell_en'), 1000); }} />}
                                {lessonStep === 'spell_en' && <div key={queueIndex} className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8"><div className="text-6xl mb-6">{currentWord.image}</div><h3 className="text-xl font-bold text-gray-600 mb-8">Spell in English!</h3><SpellingGame key={queueIndex} targetText={currentWord.word_en} lang="en" onComplete={() => { setTimeout(() => setLessonStep('trace_en'), 1000); }} /></div>}
                                {lessonStep === 'trace_en' && <div className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8 h-full w-full"><WordTracer text={currentWord.word_en} label="Trace English" onComplete={() => { setTimeout(() => setLessonStep('type_en'), 800); }} /></div>}
                                {lessonStep === 'type_en' && (
                                    <TypingGame 
                                        word={currentWord} 
                                        onComplete={() => { 
                                            if (gameMode === 'english') { 
                                                handleLessonComplete(); 
                                            } else { 
                                                speak("Now in Hindi!", 'en-US'); 
                                                setLessonStep('memorize_hi'); 
                                            } 
                                        }} 
                                        onTeachAgain={() => {
                                            setLessonStep('memorize_en'); 
                                        }}
                                    />
                                )}
                                {lessonStep === 'memorize_hi' && <MemorizeGame key={queueIndex + '_hi'} text={currentWord.word_hi} lang="hi" image={currentWord.image} onComplete={() => { playSound('success'); setTimeout(() => setLessonStep('spell_hi'), 1000); }} />}
                                {lessonStep === 'spell_hi' && <div key={queueIndex + '_hi_spell'} className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8"><div className="text-6xl mb-6">{currentWord.image}</div><h3 className="text-xl font-bold text-gray-600 mb-8">Spell in Hindi!</h3><SpellingGame key={queueIndex + '_hi_spell'} targetText={currentWord.word_hi} lang="hi" onComplete={() => { setTimeout(() => setLessonStep('trace_hi'), 1000); }} /></div>}
                                {lessonStep === 'trace_hi' && <div className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8 h-full w-full"><WordTracer text={currentWord.word_hi} label="Trace Hindi" onComplete={() => { handleLessonComplete(); }} /></div>}
                            </div>
                        </div>
                    </div>
                )}
              </>
          );
        };

        const root = createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
  </body>
</html>
