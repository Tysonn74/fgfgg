<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶Å</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Made For Ruthveika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            animation: {
              'bounce': 'bounce 1s infinite',
              'in': 'zoomIn 0.3s ease-out',
              'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
            },
            keyframes: {
              zoomIn: {
                '0%': { opacity: '0', transform: 'scale(0.8)' },
                '100%': { opacity: '1', transform: 'scale(1)' },
              },
              shake: {
                '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        overscroll-behavior: none;
        touch-action: pan-y;
      }
      .touch-none {
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Error Handler UI -->
    <div id="error-boundary" style="display: none; padding: 20px; background: #fee2e2; color: #991b1b; height: 100vh; font-family: sans-serif;">
        <h2 style="font-weight: bold; font-size: 1.5rem; margin-bottom: 10px;">Something went wrong ü¶Å</h2>
        <p>Please refresh the page. If this persists, the storage might be full.</p>
        <button onclick="localStorage.clear(); window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: bold;">Reset App Data</button>
        <pre id="error-msg" style="margin-top: 20px; font-size: 0.8rem; overflow: auto;"></pre>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-boundary').style.display = 'block';
            document.getElementById('error-msg').textContent = message + '\nAt: ' + source + ':' + lineno;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
          Play, Star, Settings, Plus, Trash2, Home, 
          ArrowRight, Eraser, Volume2, Award, Save, Check,
          Sparkles, RotateCcw, X, Languages, Type, Square, CheckSquare,
          Repeat, Music, BookOpen, Camera
        } from 'https://esm.sh/lucide-react@0.330.0';

        /* -------------------------------------------------------------------------- */
        /* UTILITIES & DATA                            */
        /* -------------------------------------------------------------------------- */

        // Sounds
        const SOUNDS = {
          success: 'https://codeskulptor-demos.commondatastorage.googleapis.com/show/sound2.mp3', // Chime
          error: 'https://codeskulptor-demos.commondatastorage.googleapis.com/assets/sound/dog_bark.mp3', // Gentle error
          pop: 'https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3', // Click/Pop
          complete: 'https://codeskulptor-demos.commondatastorage.googleapis.com/week7-brrring.m4a', // Level up
          select: 'https://codeskulptor-demos.commondatastorage.googleapis.com/assets/sound/click.m4a', // Soft click
          tick: 'https://codeskulptor-demos.commondatastorage.googleapis.com/assets/sound/click.m4a', // Tick sound
        };

        const playSound = (type) => {
          try {
            const audio = new Audio(SOUNDS[type]);
            audio.volume = type === 'error' ? 0.3 : 0.6;
            audio.play().catch(e => { /* Ignore auto-play blocks */ });
          } catch (e) {
            // Audio not supported
          }
        };

        // --- SMART PHONICS ENGINE ---
        const BASE_PHONICS = {
          '‡§ï': 'k', '‡§ñ': 'kh', '‡§ó': 'g', '‡§ò': 'gh', '‡§ô': 'ng',
          '‡§ö': 'ch', '‡§õ': 'chh', '‡§ú': 'j', '‡§ù': 'jh', '‡§û': 'ny',
          '‡§ü': 't', '‡§†': 'th', '‡§°': 'd', '‡§¢': 'dh', '‡§£': 'n',
          '‡§§': 't', '‡§•': 'th', '‡§¶': 'd', '‡§ß': 'dh', '‡§®': 'n',
          '‡§™': 'p', '‡§´': 'ph', '‡§¨': 'b', '‡§≠': 'bh', '‡§Æ': 'm',
          '‡§Ø': 'y', '‡§∞': 'r', '‡§≤': 'l', '‡§µ': 'v', '‡§∂': 'sh',
          '‡§∑': 'sh', '‡§∏': 's', '‡§π': 'h', '‡§ï‡•ç‡§∑': 'ksh', '‡§§‡•ç‡§∞': 'tr', '‡§ú‡•ç‡§û': 'gy',
          '‡§Ö': 'a', '‡§Ü': 'aa', '‡§á': 'i', '‡§à': 'ee', '‡§â': 'u', '‡§ä': 'oo',
          '‡§è': 'e', '‡§ê': 'ai', '‡§ì': 'o', '‡§î': 'au', '‡§Ö‡§Ç': 'an', '‡§Ö‡§É': 'ah', '‡§ã': 'ri'
        };

        const MATRA_PHONICS = {
          '‡§æ': 'aa', '‡§ø': 'i', '‡•Ä': 'ee', '‡•Å': 'u', '‡•Ç': 'oo',
          '‡•á': 'e', '‡•à': 'ai', '‡•ã': 'o', '‡•å': 'au', '‡§Ç': 'n', '‡§É': 'ah', '‡•É': 'ri',
          '‡•ç': '' 
        };

        const getPhonetic = (grapheme) => {
          if (!grapheme) return '';
          if (BASE_PHONICS[grapheme]) return BASE_PHONICS[grapheme] + 'a';
          if (grapheme.length === 1 && BASE_PHONICS[grapheme] === undefined) return '';

          let sound = '';
          let chars = Array.from(grapheme);
          let baseChar = chars[0];
          
          if (BASE_PHONICS[baseChar]) {
            sound += BASE_PHONICS[baseChar];
            let hasMatra = false;
            for (let i = 1; i < chars.length; i++) {
              const char = chars[i];
              if (MATRA_PHONICS[char] !== undefined) {
                sound += MATRA_PHONICS[char];
                hasMatra = true;
              }
            }
            if (!hasMatra) sound += 'a';
          } else {
              sound = BASE_PHONICS[baseChar] || '';
          }
          return sound;
        };

        // Helper to split words into tiles (Safe Version)
        const getGraphemes = (text) => {
          if (!text) return [];
          try {
            if (typeof Intl !== 'undefined' && Intl.Segmenter) {
              const segmenter = new Intl.Segmenter('hi-IN', { granularity: 'grapheme' });
              return [...segmenter.segment(text)].map(s => s.segment);
            }
          } catch (e) {
            console.warn("Intl.Segmenter not supported", e);
          }
          return Array.from(text);
        };

        // Raw Word Data
        const RAW_DATA = [
          { en: 'Cow', hi: '‡§ó‡§æ‡§Ø', tr: 'Gaay', img: 'üêÆ' },
          { en: 'Tiger', hi: '‡§¨‡§æ‡§ò', tr: 'Baagh', img: 'üêØ' },
          { en: 'Grass', hi: '‡§ò‡§æ‡§∏', tr: 'Ghaas', img: 'üåø' },
          { en: 'Soft', hi: '‡§®‡§∞‡§Æ', tr: 'Naram', img: '‚òÅÔ∏è' },
          { en: 'Salt', hi: '‡§®‡§Æ‡§ï', tr: 'Namak', img: 'üßÇ' },
          { en: 'Hot', hi: '‡§ó‡§∞‡§Æ', tr: 'Garam', img: '‚òï' },
          { en: 'Help', hi: '‡§Æ‡§¶‡§¶', tr: 'Madad', img: 'ü§ù' },
          { en: 'Honey', hi: '‡§∂‡§π‡§¶', tr: 'Shahad', img: 'üçØ' },
          { en: 'City', hi: '‡§∂‡§π‡§∞', tr: 'Shahar', img: 'üèôÔ∏è' },
          { en: 'Ginger', hi: '‡§Ö‡§¶‡§∞‡§ï', tr: 'Adrak', img: 'ü´ö' },
          { en: 'Coat', hi: '‡§Ö‡§ö‡§ï‡§®', tr: 'Achkan', img: 'üß•' },
          { en: 'Vessels', hi: '‡§¨‡§∞‡§§‡§®', tr: 'Bartan', img: 'ü•£' },
          { en: 'Banyan', hi: '‡§¨‡§∞‡§ó‡§¶', tr: 'Bargad', img: 'üå≥' },
          { en: 'Neck', hi: '‡§ó‡§∞‡§¶‡§®', tr: 'Gardan', img: 'üß£' },
          { en: 'Exercise', hi: '‡§ï‡§∏‡§∞‡§§', tr: 'Kasrat', img: 'üèãÔ∏è' },
          { en: 'Talk', hi: '‡§¨‡§æ‡§§', tr: 'Baat', img: 'üó£Ô∏è' },
          { en: 'Brother', hi: '‡§≠‡§æ‡§à', tr: 'Bhai', img: 'üë¶' },
          { en: 'Year', hi: '‡§∏‡§æ‡§≤', tr: 'Saal', img: 'üìÖ' },
          { en: 'Boat', hi: '‡§®‡§æ‡§µ', tr: 'Naav', img: '‚õµ' },
          { en: 'Lesson', hi: '‡§™‡§æ‡§†', tr: 'Paath', img: 'üìñ' },
          { en: 'Black', hi: '‡§ï‡§æ‡§≤‡§æ', tr: 'Kaala', img: '‚¨õ' },
          { en: 'Garland', hi: '‡§Æ‡§æ‡§≤‡§æ', tr: 'Maala', img: 'üèµÔ∏è' },
          { en: 'Lock', hi: '‡§§‡§æ‡§≤‡§æ', tr: 'Taala', img: 'üîí' },
          { en: 'Mother', hi: '‡§Æ‡§æ‡§§‡§æ', tr: 'Maata', img: 'üë©' },
          { en: 'Uncle', hi: '‡§Æ‡§æ‡§Æ‡§æ', tr: 'Mama', img: 'üë®' },
          { en: 'Star', hi: '‡§§‡§æ‡§∞‡§æ', tr: 'Taara', img: '‚≠ê' },
          { en: 'Grains', hi: '‡§¶‡§æ‡§®‡§æ', tr: 'Daana', img: 'üåæ' },
          { en: 'Pomegranate', hi: '‡§Ö‡§®‡§æ‡§∞', tr: 'Anaar', img: 'üçé' },
          { en: 'Carrot', hi: '‡§ó‡§æ‡§ú‡§∞', tr: 'Gaajar', img: 'ü•ï' },
          { en: 'Ship', hi: '‡§ú‡§π‡§æ‡§ú', tr: 'Jahaaz', img: 'üö¢' },
          { en: 'Food', hi: '‡§ñ‡§æ‡§®‡§æ', tr: 'Khaana', img: 'ü•ò' },
          { en: 'Song', hi: '‡§ó‡§æ‡§®‡§æ', tr: 'Gaana', img: 'üéµ' },
          { en: 'Pond', hi: '‡§§‡§æ‡§≤‡§æ‡§¨', tr: 'Taalaab', img: 'üíß' },
          { en: 'Sky', hi: '‡§Ü‡§ï‡§æ‡§∂', tr: 'Aakaash', img: '‚òÅÔ∏è' },
          { en: 'Market', hi: '‡§¨‡§æ‡§ú‡§æ‡§∞', tr: 'Baazaar', img: 'üè™' },
          { en: 'Tomato', hi: '‡§ü‡§Æ‡§æ‡§ü‡§∞', tr: 'Tamaatar', img: 'üçÖ' },
          { en: 'Ocean', hi: '‡§∏‡§æ‡§ó‡§∞', tr: 'Saagar', img: 'üåä' },
          { en: 'House', hi: '‡§Æ‡§ï‡§æ‡§®', tr: 'Makaan', img: 'üè†' }
        ];

        const generateDefaults = () => {
          const defaults = [];
          let idCounter = 1;
          RAW_DATA.forEach(w => {
            defaults.push({ id: `dual_${idCounter}`, word_en: w.en, word_hi: w.hi, transliteration: w.tr, image: w.img, mode: 'dual' });
            idCounter++;
          });
          RAW_DATA.forEach(w => {
            defaults.push({ id: `eng_${idCounter}`, word_en: w.en, word_hi: w.hi, transliteration: w.tr, image: w.img, mode: 'english' });
            idCounter++;
          });
          return defaults;
        };

        const DEFAULT_WORDS = generateDefaults();

        const SMART_DICTIONARY = {};
        RAW_DATA.forEach(w => {
          SMART_DICTIONARY[w.en.toLowerCase()] = { hi: w.hi, trans: w.tr, emoji: w.img };
        });
        SMART_DICTIONARY['cat'] = { hi: '‡§¨‡§ø‡§≤‡•ç‡§≤‡•Ä', trans: 'Billi', emoji: 'üê±' };
        SMART_DICTIONARY['book'] = { hi: '‡§ï‡§ø‡§§‡§æ‡§¨', trans: 'Kitaab', emoji: 'üìö' };

        const triggerConfetti = () => {
          const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
          for (let i = 0; i < 50; i++) {
            const el = document.createElement('div');
            el.style.position = 'fixed';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.top = '-10px';
            el.style.width = '10px';
            el.style.height = '10px';
            el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            el.style.borderRadius = '50%';
            el.style.zIndex = '9999';
            el.style.pointerEvents = 'none';
            el.style.transition = 'top 1s ease-in, opacity 1s ease-in';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1100);
          }
        };

        const speak = (text, lang = 'en-US') => {
          if (!window.speechSynthesis) return;
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = lang;
          utterance.rate = 0.8;
          utterance.pitch = 1.1;
          
          if (lang === 'hi-IN' || lang === 'hi') {
              const voices = window.speechSynthesis.getVoices();
              const hindiVoice = voices.find(v => v.lang.includes('hi'));
              if (hindiVoice) {
                  utterance.voice = hindiVoice;
              }
          }
          
          window.speechSynthesis.speak(utterance);
        };


        /* -------------------------------------------------------------------------- */
        /* COMPONENTS                                  */
        /* -------------------------------------------------------------------------- */

        // 1. Session Setup Component
        const SessionSetup = ({ words, mode, onStart, onBack }) => {
          const [selectedIds, setSelectedIds] = useState(new Set());
          const [repeats, setRepeats] = useState(3); 
          const [searchTerm, setSearchTerm] = useState('');

          const modeWords = words.filter(w => w.mode === mode);
          const displayedWords = modeWords.filter(w => 
            w.word_en && w.word_en.toLowerCase().includes(searchTerm.toLowerCase())
          );

          const toggleSelection = (id) => {
            playSound('select');
            const next = new Set(selectedIds);
            if (next.has(id)) next.delete(id);
            else next.add(id);
            setSelectedIds(next);
          };

          const toggleSelectAll = () => {
            playSound('select');
            if (selectedIds.size === displayedWords.length) {
              setSelectedIds(new Set());
            } else {
              setSelectedIds(new Set(displayedWords.map(w => w.id)));
            }
          };

          const handleStart = () => {
            if (selectedIds.size === 0) return;
            playSound('pop');
            const selectedWordsList = words.filter(w => selectedIds.has(w.id));
            const queue = [];
            selectedWordsList.forEach(word => {
                for(let i=0; i<repeats; i++) {
                    queue.push(word);
                }
            });
            onStart(queue);
          };

          return (
            <div className="fixed inset-0 bg-indigo-50 z-50 flex flex-col">
              <div className="flex-1 flex flex-col max-w-2xl mx-auto w-full bg-white shadow-2xl h-full relative">
                  {/* Header */}
                  <div className="bg-indigo-600 p-4 text-white flex-shrink-0 shadow-md z-10">
                    <div className="flex items-center justify-between mb-4">
                        <button onClick={onBack} className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition">
                            <ArrowRight className="rotate-180" />
                        </button>
                        <h2 className="text-xl font-bold">What to learn?</h2>
                        <div className="w-8"></div>
                    </div>
                    
                    <div className="bg-indigo-700/50 p-2 rounded-xl flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Repeat size={18} className="text-indigo-200" />
                            <span className="font-medium text-sm text-indigo-100">Repeats:</span>
                        </div>
                        <div className="flex gap-2">
                            {[1, 3, 5, 10].map(num => (
                                <button
                                    key={num}
                                    onClick={() => { playSound('select'); setRepeats(num); }}
                                    className={`w-8 h-8 rounded-lg font-bold text-sm transition-all ${repeats === num ? 'bg-white text-indigo-600 scale-110 shadow' : 'bg-indigo-800/50 text-indigo-300 hover:bg-indigo-800'}`}
                                >
                                    {num}
                                </button>
                            ))}
                        </div>
                    </div>
                  </div>

                  {/* List Controls */}
                  <div className="p-3 border-b flex items-center justify-between bg-gray-50 flex-shrink-0 shadow-sm z-10">
                      <button 
                        onClick={toggleSelectAll}
                        className="flex items-center gap-2 text-indigo-600 font-bold hover:bg-indigo-100 px-3 py-2 rounded-lg transition"
                      >
                          {selectedIds.size === displayedWords.length && displayedWords.length > 0 ? <CheckSquare size={20} /> : <Square size={20} />}
                          <span>{selectedIds.size === displayedWords.length ? 'Deselect All' : 'Select All'}</span>
                      </button>
                      <div className="text-sm text-gray-500 font-medium bg-white px-3 py-1 rounded-full border">
                          {selectedIds.size} Selected
                      </div>
                  </div>

                  {/* Scrollable Word Grid */}
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-32">
                    {displayedWords.length === 0 ? (
                        <div className="text-center py-10 text-gray-400">No words found</div>
                    ) : (
                        displayedWords.map(word => (
                            <div 
                                key={word.id}
                                onClick={() => toggleSelection(word.id)}
                                className={`flex items-center p-3 rounded-xl border-2 transition-all cursor-pointer select-none active:scale-98
                                    ${selectedIds.has(word.id) ? 'border-green-500 bg-green-50' : 'border-gray-100 bg-white'}`}
                            >
                                <div className={`w-6 h-6 rounded border mr-4 flex-shrink-0 flex items-center justify-center transition-colors
                                    ${selectedIds.has(word.id) ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300'}`}>
                                    {selectedIds.has(word.id) && <Check size={14} className="text-white" />}
                                </div>
                                <span className="text-4xl mr-4">{word.image}</span>
                                <div>
                                    <div className="font-bold text-gray-800 text-lg">{word.word_en}</div>
                                    {mode === 'dual' && <div className="text-sm text-gray-500 font-medium">{word.word_hi}</div>}
                                </div>
                            </div>
                        ))
                    )}
                  </div>

                  {/* Fixed Footer */}
                  <div className="p-4 border-t bg-white flex-shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] absolute bottom-0 w-full max-w-2xl left-0 right-0 mx-auto">
                      <button 
                        onClick={handleStart}
                        disabled={selectedIds.size === 0}
                        className={`w-full py-4 rounded-xl font-bold text-xl flex items-center justify-center gap-2 transition-all shadow-lg
                            ${selectedIds.size > 0 
                                ? 'bg-green-500 text-white hover:bg-green-600 active:scale-95' 
                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'}
                        `}
                      >
                        <Play fill="currentColor" /> Let's Go!
                      </button>
                  </div>
              </div>
            </div>
          );
        };

        // 2. Updated Memorize Phase Component
        const MemorizeGame = ({ text = "", lang, image, onComplete }) => {
          const [activeIndex, setActiveIndex] = useState(-1);
          const [loopCount, setLoopCount] = useState(0);
          
          const safeText = text || "";
          const parts = lang === 'en' ? safeText.toUpperCase().split('') : getGraphemes(safeText);
          const TOTAL_LOOPS = 1; 

          useEffect(() => {
            let timeout;
            
            const runSequence = async () => {
              if (loopCount === 0 && activeIndex === -1) {
                await new Promise(r => setTimeout(r, 500));
              }

              if (loopCount < TOTAL_LOOPS) {
                for (let i = 0; i < parts.length; i++) {
                  setActiveIndex(i);
                  const part = parts[i];
                  
                  if (lang === 'hi') {
                    speak(part, 'hi-IN'); 
                  } else {
                    speak(part, 'en-US');
                  }
                  
                  await new Promise(r => setTimeout(r, 1200));
                }
                
                setActiveIndex(-1);
                await new Promise(r => setTimeout(r, 300));
                
                speak(safeText, lang === 'hi' ? 'hi-IN' : 'en-US');
                
                await new Promise(r => setTimeout(r, 1000)); 
                setLoopCount(prev => prev + 1);
              } else {
                onComplete();
              }
            };

            runSequence();
            return () => clearTimeout(timeout);
          }, [loopCount, safeText, lang]); 

          return (
            <div className="flex-1 flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
                <h2 className="text-2xl font-bold text-gray-500 mb-8">Memorize: {lang === 'en' ? 'English' : 'Hindi'}</h2>
                <div className="text-6xl mb-8">{image}</div>
                
                <div className="flex flex-wrap gap-2 justify-center mb-12">
                    {parts.map((char, idx) => (
                        <div 
                            key={idx}
                            className={`
                                flex flex-col items-center justify-center p-4 rounded-xl border-4 transition-all duration-300
                                ${activeIndex === idx 
                                    ? 'bg-yellow-100 border-yellow-400 scale-125 shadow-xl z-10' 
                                    : 'bg-white border-gray-100 scale-100 opacity-50'}
                            `}
                            style={{ minWidth: '70px', minHeight: '90px' }}
                        >
                            <span className="text-4xl font-bold text-gray-800">{char}</span>
                            {lang === 'hi' && (
                                <span className={`text-sm font-bold mt-2 uppercase ${activeIndex === idx ? 'text-yellow-700' : 'text-gray-300'}`}>
                                    {getPhonetic(char)}
                                </span>
                            )}
                        </div>
                    ))}
                </div>
                <p className="mt-4 text-gray-400 text-sm animate-pulse">Listen & Watch...</p>
            </div>
          );
        };

        // 3. Tracing Canvas (RESTORED)
        const TracingCanvas = ({ text, label, onComplete }) => {
          const canvasRef = useRef(null);
          const [isDrawing, setIsDrawing] = useState(false);
          const [coverage, setCoverage] = useState(0);
          const [shake, setShake] = useState(false);
          
          useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const timer = setTimeout(() => {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                if (rect.width === 0) return;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                drawGuide(ctx, rect.width, rect.height);
                setCoverage(0);
            }, 50);
            return () => clearTimeout(timer);
          }, [text]);

          const drawGuide = (ctx, width, height) => {
            ctx.clearRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'source-over'; 
            ctx.font = 'bold 130px Arial, sans-serif'; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#e5e7eb'; 
            ctx.fillText(text, width / 2, height / 2);
          };

          const calculateCoverage = () => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            try {
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const data = imageData.data;
              let totalFilled = 0;
              let totalGuide = 0;
              for (let i = 0; i < data.length; i += 80) { 
                const g = data[i + 1];
                const a = data[i + 3];
                if (a > 20) {
                    totalGuide++;
                    if (g < 150) totalFilled++;
                }
              }
              if (totalGuide > 0) setCoverage(Math.round((totalFilled / totalGuide) * 100));
            } catch (e) { setCoverage(100); }
          };

          const startDrawing = (e) => {
            if(e.cancelable) e.preventDefault();
            setIsDrawing(true);
            const canvas = canvasRef.current;
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            
            const ctx = canvas.getContext('2d');
            ctx.globalCompositeOperation = 'source-atop'; 
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.strokeStyle = '#ec4899'; 
            ctx.lineWidth = 40; 
          };

          const draw = (e) => {
            if (!isDrawing) return;
            if(e.cancelable) e.preventDefault();
            const canvas = canvasRef.current;
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            
            const ctx = canvas.getContext('2d');
            ctx.lineTo(x, y);
            ctx.stroke();
          };

          const stopDrawing = (e) => {
            if (isDrawing) {
                if(e && e.cancelable) e.preventDefault();
                setIsDrawing(false);
                const ctx = canvasRef.current.getContext('2d');
                ctx.closePath();
                calculateCoverage();
            }
          };

          const handleNext = () => {
            if (coverage > 80) {
                onComplete();
            } else {
                setShake(true);
                playSound('error');
                speak("Fill the whole letter!");
                setTimeout(() => setShake(false), 500);
            }
          };

          return (
            <div className="flex flex-col items-center w-full">
              <h3 className="text-xl font-bold text-gray-500 mb-2 uppercase tracking-wider">{label}</h3>
              <div className={`relative border-4 border-dashed border-indigo-200 rounded-3xl bg-white overflow-hidden shadow-inner w-full max-w-sm aspect-video ${shake ? 'animate-shake border-red-400' : ''}`}>
                 <canvas
                  ref={canvasRef}
                  className="w-full h-full cursor-crosshair touch-none"
                  style={{ touchAction: 'none' }} 
                  onMouseDown={startDrawing}
                  onMouseMove={draw}
                  onMouseUp={stopDrawing}
                  onMouseLeave={stopDrawing}
                  onTouchStart={startDrawing}
                  onTouchMove={draw}
                  onTouchEnd={stopDrawing}
                />
                <div className="absolute bottom-2 left-2 right-2 h-3 bg-gray-100 rounded-full overflow-hidden border border-gray-200">
                    <div className={`h-full transition-all duration-300 ${coverage > 80 ? 'bg-green-500' : 'bg-pink-500'}`} style={{ width: `${coverage}%` }} />
                </div>
              </div>
              <div className="mt-6 flex gap-4 w-full max-w-sm">
                <button 
                  onClick={() => {
                      const canvas = canvasRef.current;
                      const ctx = canvas.getContext('2d');
                      const rect = canvas.getBoundingClientRect();
                      drawGuide(ctx, rect.width, rect.height);
                      setCoverage(0);
                  }}
                  className="p-4 bg-gray-200 rounded-xl hover:bg-gray-300 transition text-gray-700 font-bold flex-1"
                >
                  <Eraser className="inline mr-2" /> Reset
                </button>
                <button 
                  onClick={handleNext}
                  className={`p-4 rounded-xl transition font-bold flex-1 flex items-center justify-center gap-2 shadow-lg
                    ${coverage > 80 ? 'bg-green-500 text-white hover:bg-green-600 transform hover:scale-105' : 'bg-gray-300 text-gray-500'}
                  `}
                >
                  Next <Check size={20} />
                </button>
              </div>
            </div>
          );
        };

        // 4. Spelling Game (Improved UI & Phonics)
        const SpellingGame = ({ targetText, onComplete, lang = 'en' }) => {
          const isEnglish = /[a-zA-Z]/.test(targetText);
          const displayChars = isEnglish 
            ? (targetText || "").toUpperCase().split('') 
            : getGraphemes(targetText);

          const [shuffledTiles, setShuffledTiles] = useState([]);
          const [placedTiles, setPlacedTiles] = useState(Array(displayChars.length).fill(null));
          const [feedback, setFeedback] = useState(null); 
          const [showCorrection, setShowCorrection] = useState(false);

          useEffect(() => {
            resetGame();
          }, [targetText]);

          const resetGame = () => {
            const chars = displayChars.map((char, id) => ({ char, id: `tile-${id}-${Math.random()}` }));
            for (let i = chars.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [chars[i], chars[j]] = [chars[j], chars[i]];
            }
            setShuffledTiles(chars);
            setPlacedTiles(Array(displayChars.length).fill(null));
            setFeedback(null);
            setShowCorrection(false);
          };

          const handleTileClick = (tile, fromIndex, isFromBank) => {
            if (feedback === 'success' || showCorrection) return;

            if (isFromBank) {
              const firstEmptyIndex = placedTiles.findIndex(t => t === null);
              if (firstEmptyIndex !== -1) {
                playSound('pop');
                const newPlaced = [...placedTiles];
                newPlaced[firstEmptyIndex] = tile;
                setPlacedTiles(newPlaced);
                setShuffledTiles(prev => prev.filter(t => t.id !== tile.id));
                speak(tile.char, lang === 'hi' ? 'hi-IN' : 'en-US');

                if (firstEmptyIndex === placedTiles.length - 1) {
                  checkSpelling(newPlaced);
                }
              }
            } else {
              playSound('pop');
              const newPlaced = [...placedTiles];
              newPlaced[fromIndex] = null;
              setPlacedTiles(newPlaced);
              setShuffledTiles(prev => [...prev, tile]);
              setFeedback(null);
            }
          };

          const checkSpelling = (currentPlaced) => {
            const spelledWord = currentPlaced.map(t => t.char).join('');
            const target = displayChars.join('');
            
            if (spelledWord === target) {
              setFeedback('success');
              triggerConfetti();
              playSound('success');
              setTimeout(() => {
                  speak(targetText, lang === 'hi' ? 'hi-IN' : 'en-US');
              }, 500);
              
              setTimeout(onComplete, 2000);
            } else {
              setFeedback('error');
              playSound('error');
              setShowCorrection(true);
              setTimeout(() => {
                resetGame();
              }, 2500);
            }
          };

          const TileContent = ({ char }) => (
            <>
                <span className="text-3xl font-bold mb-1 text-indigo-900">{char}</span>
                {lang === 'hi' && (
                    <span className="text-sm text-indigo-500 font-bold tracking-wider uppercase font-mono bg-indigo-50 px-2 rounded-lg mt-1">
                        {getPhonetic(char)}
                    </span>
                )}
            </>
          );

          return (
            <div className="flex flex-col items-center w-full max-w-md mx-auto">
              {/* Feedback Overlay */}
              {showCorrection && (
                <div className="mb-4 p-4 bg-red-100 border-2 border-red-300 rounded-xl text-center animate-bounce">
                  <p className="text-red-800 font-bold text-sm">Oops! The correct spelling is:</p>
                  <p className="text-3xl font-black text-red-600 tracking-widest mt-1">{displayChars.join('')}</p>
                </div>
              )}

              {/* Slots */}
              <div className="flex gap-2 mb-8 p-4 bg-indigo-50 rounded-xl shadow-inner min-h-[140px] items-center justify-center w-full flex-wrap">
                {placedTiles.map((tile, i) => (
                  <button
                    key={i}
                    onClick={() => tile && handleTileClick(tile, i, false)}
                    className={`
                      w-16 h-24 sm:w-20 sm:h-28 border-b-4 rounded-2xl flex flex-col items-center justify-center transition-all transform
                      ${tile ? 'bg-white border-indigo-200 shadow-md scale-100' : 'bg-gray-100 border-gray-200 border-dashed'}
                      ${feedback === 'error' ? 'animate-shake border-red-400 bg-red-50' : ''}
                      ${feedback === 'success' ? 'border-green-400 bg-green-50 scale-110' : ''}
                    `}
                  >
                    {tile && <TileContent char={tile.char} />}
                  </button>
                ))}
              </div>

              {/* Letter Bank */}
              <div className="flex flex-wrap justify-center gap-3">
                {shuffledTiles.map((tile) => (
                  <button
                    key={tile.id}
                    onClick={() => handleTileClick(tile, null, true)}
                    className="w-16 h-24 sm:w-20 sm:h-28 bg-white border-b-4 border-indigo-200 rounded-2xl shadow-sm flex flex-col items-center justify-center active:scale-95 hover:-translate-y-1 transition-transform"
                  >
                    <TileContent char={tile.char} />
                  </button>
                ))}
              </div>
            </div>
          );
        };

        // Helper components outside to prevent recreation
        const WordRow = ({ word, isSelected, toggleSelection }) => {
            return (
                <div 
                    onClick={() => toggleSelection(word.id)}
                    className={`flex items-center p-3 border rounded-lg shadow-sm mb-2 cursor-pointer transition-all ${isSelected ? 'bg-blue-50 border-blue-400 ring-1 ring-blue-400' : 'bg-white border-gray-200 hover:bg-gray-50'}`}
                >
                    <div className={`w-6 h-6 rounded border mr-4 flex items-center justify-center transition-colors ${isSelected ? 'bg-blue-500 border-blue-500' : 'bg-white border-gray-300'}`}>
                        {isSelected && <Check size={16} className="text-white" />}
                    </div>
                    <div className="flex items-center gap-3 flex-1">
                        <span className="text-2xl">{word.image}</span>
                        <div>
                            <div className="font-bold text-gray-800">{word.word_en}</div>
                            {word.mode === 'dual' && <div className="text-xs text-gray-500">{word.word_hi}</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ words, setWords, goBack }) => {
          const [newWord, setNewWord] = useState({ id: '', word_en: '', word_hi: '', transliteration: '', image: 'üçé', mode: 'dual' });
          const [selectedIds, setSelectedIds] = useState(new Set());
          const [confirmDelete, setConfirmDelete] = useState(false);

          const toggleSelection = (id) => {
            const next = new Set(selectedIds);
            if (next.has(id)) next.delete(id); else next.add(id);
            setSelectedIds(next);
          };

          const selectAll = (mode) => {
            const modeWords = words.filter(w => w.mode === mode);
            const modeIds = modeWords.map(w => w.id);
            const next = new Set(selectedIds);
            const allSelected = modeIds.every(id => next.has(id));
            if (allSelected) modeIds.forEach(id => next.delete(id)); else modeIds.forEach(id => next.add(id));
            setSelectedIds(next);
          };

          const deleteSelected = () => {
            if (confirmDelete) {
                setWords(words.filter(w => !selectedIds.has(w.id)));
                setSelectedIds(new Set());
                setConfirmDelete(false);
                playSound('pop');
            } else {
                setConfirmDelete(true);
                setTimeout(() => setConfirmDelete(false), 3000);
            }
          };

          const handleEnglishChange = (e) => {
            const val = e.target.value;
            let updatedWord = { ...newWord, word_en: val };
            if (SMART_DICTIONARY[val.toLowerCase().trim()]) {
              const info = SMART_DICTIONARY[val.toLowerCase().trim()];
              updatedWord = { ...updatedWord, word_hi: info.hi, transliteration: info.trans, image: info.emoji };
            }
            setNewWord(updatedWord);
          };

          const handleAdd = () => {
            if (!newWord.word_en) return;
            const word = { ...newWord, id: Date.now().toString() };
            setWords([...words, word]);
            setNewWord({ id: '', word_en: '', word_hi: '', transliteration: '', image: 'üçé', mode: newWord.mode });
            playSound('success');
          };

          return (
            <div className="min-h-screen bg-gray-50 p-4 font-sans">
              <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden pb-20">
                <header className="bg-gray-800 text-white p-4 flex items-center justify-between sticky top-0 z-10 shadow-md">
                    <button onClick={goBack} className="hover:bg-gray-700 p-2 rounded"><ArrowRight className="rotate-180" /></button>
                    <h2 className="font-bold text-lg">Parent Dashboard</h2>
                    <div className="w-8"></div>
                </header>

                {selectedIds.size > 0 && (
                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 animate-in slide-in-from-bottom-4">
                        <button 
                            onClick={deleteSelected}
                            className={`flex items-center gap-2 px-6 py-3 rounded-full font-bold shadow-xl transition-all ${confirmDelete ? 'bg-red-600 text-white scale-110' : 'bg-gray-900 text-white hover:bg-black'}`}
                        >
                            <Trash2 size={20} />
                            {confirmDelete ? 'Tap again to Confirm' : `Delete ${selectedIds.size} Selected`}
                        </button>
                    </div>
                )}

                <div className="p-6 space-y-8">
                    <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 relative overflow-hidden">
                        <div className="absolute top-0 right-0 bg-yellow-200 text-yellow-800 text-xs font-bold px-2 py-1 rounded-bl-lg">
                            <Sparkles size={12} className="inline mr-1" /> Smart Auto-Fill Active
                        </div>
                        <h3 className="text-blue-900 font-bold mb-4 flex items-center gap-2"><Plus size={20}/> Add New Word</h3>
                        <div className="flex gap-4 mb-4">
                            <label className="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-blue-100 transition">
                                <input type="radio" name="wordMode" checked={newWord.mode === 'english'} onChange={() => setNewWord({...newWord, mode: 'english'})} className="w-4 h-4 text-blue-600" />
                                <span className="font-bold text-gray-700">English Only</span>
                            </label>
                            <label className="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-blue-100 transition">
                                <input type="radio" name="wordMode" checked={newWord.mode === 'dual'} onChange={() => setNewWord({...newWord, mode: 'dual'})} className="w-4 h-4 text-green-600" />
                                <span className="font-bold text-gray-700">English & Hindi</span>
                            </label>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div className="col-span-1 sm:col-span-2">
                                <label className="text-xs text-blue-700 font-bold ml-1 mb-1 block">English Word</label>
                                <input placeholder="e.g. Lion" className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg" value={newWord.word_en} onChange={handleEnglishChange} />
                            </div>
                            {newWord.mode === 'dual' && (
                                <>
                                    <input placeholder="Hindi (e.g. ‡§∏‡•á‡§¨)" className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={newWord.word_hi} onChange={e => setNewWord({...newWord, word_hi: e.target.value})} />
                                    <input placeholder="Transliteration (e.g. Seb)" className="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={newWord.transliteration} onChange={e => setNewWord({...newWord, transliteration: e.target.value})} />
                                </>
                            )}
                            <input placeholder="Emoji (e.g. üçé)" className={`p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-2xl text-center ${newWord.mode === 'english' ? 'col-span-2' : ''}`} value={newWord.image} onChange={e => setNewWord({...newWord, image: e.target.value})} />
                        </div>
                        <button onClick={handleAdd} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex justify-center items-center gap-2">
                            <Save size={20} /> Add to {newWord.mode === 'english' ? 'English' : 'Dual'} List
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="bg-gray-50 rounded-xl p-4 border shadow-sm">
                            <div className="flex items-center justify-between mb-4 pb-2 border-b">
                                <h3 className="font-bold text-blue-800 flex items-center gap-2"><Type size={18} /> English Only</h3>
                                <button onClick={() => selectAll('english')} className="text-xs text-blue-600 font-bold hover:underline">Select All</button>
                            </div>
                            <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                {words.filter(w => w.mode === 'english').map(word => 
                                    <WordRow 
                                        key={word.id} 
                                        word={word} 
                                        isSelected={selectedIds.has(word.id)}
                                        toggleSelection={toggleSelection}
                                    />
                                )}
                                {words.filter(w => w.mode === 'english').length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">No words yet</p>}
                            </div>
                        </div>
                        <div className="bg-gray-50 rounded-xl p-4 border shadow-sm">
                            <div className="flex items-center justify-between mb-4 pb-2 border-b">
                                <h3 className="font-bold text-green-800 flex items-center gap-2"><Languages size={18} /> Dual Language</h3>
                                <button onClick={() => selectAll('dual')} className="text-xs text-green-600 font-bold hover:underline">Select All</button>
                            </div>
                            <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                {words.filter(w => w.mode === 'dual').map(word => 
                                    <WordRow 
                                        key={word.id} 
                                        word={word} 
                                        isSelected={selectedIds.has(word.id)}
                                        toggleSelection={toggleSelection}
                                    />
                                )}
                                {words.filter(w => w.mode === 'dual').length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">No words yet</p>}
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
          );
        };

        // Main App Component
        const App = () => {
          // SAFE DATA LOADING
          const [words, setWords] = useState(() => {
            try {
                const saved = localStorage.getItem('spelling_bee_words');
                if (saved) {
                  const parsed = JSON.parse(saved);
                  if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].word_en && parsed[0].mode) {
                      return parsed;
                  }
                }
                return DEFAULT_WORDS;
            } catch(e) { return DEFAULT_WORDS; }
          });
          
          const [progress, setProgress] = useState(() => {
            try {
                const saved = localStorage.getItem('spelling_bee_progress');
                return saved ? JSON.parse(saved) : { stickers: 0, completedWords: [] };
            } catch(e) { return { stickers: 0, completedWords: [] }; }
          });

          const [profilePic, setProfilePic] = useState(() => {
            try {
                return localStorage.getItem('lingo_kids_profile') || null;
            } catch(e) { return null; }
          });
          
          const [mode, setMode] = useState('home'); 
          const [gameMode, setGameMode] = useState('dual');
          
          const [playQueue, setPlayQueue] = useState([]);
          const [queueIndex, setQueueIndex] = useState(0);
          const [lessonStep, setLessonStep] = useState('card');
          const fileInputRef = useRef(null);

          useEffect(() => {
            try {
                localStorage.setItem('spelling_bee_words', JSON.stringify(words));
            } catch(e) { console.error("Storage full", e); }
          }, [words]);

          useEffect(() => {
            try {
                localStorage.setItem('spelling_bee_progress', JSON.stringify(progress));
            } catch(e) { console.error("Storage full", e); }
          }, [progress]);

          useEffect(() => {
            if (profilePic) {
                try {
                    localStorage.setItem('lingo_kids_profile', profilePic);
                } catch(e) { console.error("Profile pic too large", e); }
            }
          }, [profilePic]);

          const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                // Check size (limit to 1MB)
                if (file.size > 1024 * 1024) {
                    alert("Image too large! Please choose a smaller image.");
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = () => {
                    setProfilePic(reader.result);
                };
                reader.readAsDataURL(file);
            }
          };

          const currentWord = playQueue[queueIndex];

          const handleLessonComplete = () => {
            const newProgress = { 
              ...progress, 
              stickers: progress.stickers + 1,
              completedWords: [...new Set([...progress.completedWords, currentWord.id])]
            };
            setProgress(newProgress);
            triggerConfetti();
            playSound('complete');
            
            setTimeout(() => {
                if (queueIndex + 1 >= playQueue.length) {
                    setMode('home'); 
                    speak("Session complete! Great job!", 'en-US');
                } else {
                    setLessonStep('card');
                    setQueueIndex(prev => prev + 1);
                }
            }, 2500);
          };

          if (mode === 'home') {
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-300 to-purple-300 p-6 flex flex-col items-center justify-center font-sans">
                <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center space-y-6 transform hover:scale-[1.02] transition-transform">
                  <div className="mb-4">
                    <h1 className="text-3xl font-extrabold text-indigo-600 tracking-tight drop-shadow-sm">
                        Made For
                    </h1>
                    <h1 className="text-4xl font-extrabold text-pink-500 tracking-tight drop-shadow-sm">
                        Ruthveika
                    </h1>
                  </div>
                  
                  {/* PROFILE PICTURE */}
                  <div 
                    className="relative mx-auto w-40 h-40 cursor-pointer group"
                    onClick={() => fileInputRef.current.click()}
                  >
                    <div className="w-full h-full rounded-full border-4 border-indigo-200 overflow-hidden shadow-lg bg-indigo-50 flex items-center justify-center">
                        {profilePic ? (
                            <img src={profilePic} alt="Profile" className="w-full h-full object-cover" />
                        ) : (
                            <div className="text-6xl animate-bounce">ü¶Å</div>
                        )}
                    </div>
                    <div className="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full shadow-md transition-transform transform group-hover:scale-110">
                        <Camera size={20} />
                    </div>
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        onChange={handleImageUpload} 
                        className="hidden" 
                        accept="image/*"
                    />
                  </div>
                  <p className="text-xs text-gray-400 mt-2">Tap to add photo</p>
                  
                  <div className="space-y-3 w-full mt-6">
                    <button 
                      onClick={() => { playSound('pop'); setGameMode('english'); setMode('setup'); }}
                      className="w-full py-4 bg-blue-500 border-b-8 border-blue-700 rounded-2xl text-white text-xl font-bold hover:bg-blue-600 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-2"
                    >
                      <Type size={24} /> English Only
                    </button>
                    <button 
                      onClick={() => { playSound('pop'); setGameMode('dual'); setMode('setup'); }}
                      className="w-full py-4 bg-green-500 border-b-8 border-green-700 rounded-2xl text-white text-xl font-bold hover:bg-green-600 active:border-b-0 active:translate-y-2 transition-all flex items-center justify-center gap-2"
                    >
                      <Languages size={24} /> English & Hindi
                    </button>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mt-4">
                    <button 
                      onClick={() => { playSound('pop'); setMode('stickers'); }}
                      className="py-3 bg-yellow-300 border-b-4 border-yellow-500 rounded-xl text-yellow-900 font-bold hover:bg-yellow-400 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center"
                    >
                      <Award size={24} className="mb-1"/> Stickers
                    </button>
                    <button 
                      onClick={() => { playSound('pop'); setMode('admin'); }}
                      className="py-3 bg-gray-200 border-b-4 border-gray-400 rounded-xl text-gray-700 font-bold hover:bg-gray-300 active:border-b-0 active:translate-y-1 transition-all flex flex-col items-center"
                    >
                      <Settings size={24} className="mb-1"/> Parents
                    </button>
                  </div>
                </div>
                <p className="mt-8 text-white/80 font-medium">Learn. Play. Grow.</p>
              </div>
            );
          }

          if (mode === 'setup') {
              return (
                  <SessionSetup 
                    words={words} 
                    mode={gameMode} 
                    onBack={() => setMode('home')}
                    onStart={(queue) => {
                        setPlayQueue(queue);
                        setQueueIndex(0);
                        setLessonStep('card');
                        setMode('learn');
                    }}
                  />
              );
          }

          if (mode === 'stickers') {
            return (
              <div className="min-h-screen bg-yellow-50 p-4">
                <div className="max-w-2xl mx-auto">
                  <header className="flex items-center justify-between mb-8">
                    <button onClick={() => setMode('home')} className="p-2 bg-white rounded-full shadow hover:bg-gray-50">
                        <Home className="text-indigo-600" />
                    </button>
                    <h2 className="text-3xl font-bold text-yellow-800">My Stickers</h2>
                    <div className="w-10"></div>
                  </header>
                  
                  <div className="bg-white rounded-3xl shadow-xl p-6 min-h-[60vh] relative overflow-hidden border-4 border-yellow-200">
                    {progress.stickers === 0 ? (
                      <div className="flex flex-col items-center justify-center h-full text-gray-400 mt-20">
                        <Star size={64} className="mb-4 text-gray-200" />
                        <p>Play games to earn stickers!</p>
                      </div>
                    ) : (
                      <div className="grid grid-cols-3 sm:grid-cols-4 gap-4">
                        {[...Array(progress.stickers)].map((_, i) => (
                          <div key={i} className="aspect-square flex items-center justify-center animate-in zoom-in duration-500">
                            <div className="text-5xl transform hover:scale-125 transition-transform cursor-pointer">
                              {['‚≠ê', 'üåü', 'ü¶Ñ', 'üåà', 'üç¶', 'üéà', 'üéÅ', 'üèÜ'][i % 8]}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          if (mode === 'admin') {
            return <AdminPanel words={words} setWords={setWords} goBack={() => setMode('home')} />;
          }

          const steps = gameMode === 'english' 
            ? ['card', 'memorize_en', 'spell_en', 'trace_en']
            : ['card', 'memorize_en', 'spell_en', 'trace_en', 'memorize_hi', 'spell_hi', 'trace_hi'];

          if (!currentWord) return null; 

          const sessionProgress = Math.round(((queueIndex) / playQueue.length) * 100);

          return (
            <div className="min-h-screen bg-indigo-50 flex flex-col font-sans">
              <div className="p-4 flex flex-col gap-2 bg-white shadow-sm z-10">
                <div className="flex justify-between items-center">
                    <button onClick={() => setMode('home')} className="p-2 hover:bg-gray-100 rounded-full">
                        <Home className="text-gray-500" />
                    </button>
                    <div className="flex gap-2">
                    {steps.map(step => (
                        <div 
                            key={step} 
                            className={`w-3 h-3 rounded-full transition-colors ${lessonStep === step ? 'bg-indigo-600' : 'bg-gray-300'}`} 
                        />
                    ))}
                    </div>
                    <div className="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-full text-yellow-800 font-bold">
                        <Star size={16} fill="currentColor" /> {progress.stickers}
                    </div>
                </div>
                <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div 
                        className="h-full bg-green-500 transition-all duration-500 ease-out"
                        style={{ width: `${sessionProgress}%` }}
                    />
                </div>
              </div>

              <div className="flex-1 flex flex-col items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden min-h-[500px] flex flex-col">
                    
                    {/* 1. WORD CARD */}
                    {lessonStep === 'card' && (
                        <div key={queueIndex} className="flex-1 flex flex-col items-center justify-center p-8 text-center animate-in fade-in slide-in-from-right-8">
                            <div className="text-9xl mb-8 transform hover:scale-110 transition-transform duration-300 cursor-pointer"
                                onClick={() => speak(currentWord.word_en)}>
                                {currentWord.image}
                            </div>
                            
                            <div className="space-y-2 mb-8">
                                <h2 className="text-5xl font-extrabold text-gray-800">{currentWord.word_en}</h2>
                                {gameMode === 'dual' && currentWord.word_hi && (
                                    <div className="text-gray-500 text-xl font-medium">
                                        {currentWord.word_hi} <span className="text-gray-300">‚Ä¢</span> {currentWord.transliteration}
                                    </div>
                                )}
                            </div>

                            <div className="flex gap-4">
                                <button 
                                    onClick={() => speak(currentWord.word_en)}
                                    className="p-4 bg-indigo-100 rounded-full text-indigo-600 hover:bg-indigo-200 transition-colors"
                                >
                                    <Volume2 size={32} />
                                </button>
                                {gameMode === 'dual' && (
                                    <button 
                                        onClick={() => speak(currentWord.word_hi, 'hi-IN')}
                                        className="p-4 bg-pink-100 rounded-full text-pink-600 hover:bg-pink-200 transition-colors"
                                    >
                                        <span className="font-bold text-lg">HI</span>
                                    </button>
                                )}
                            </div>

                            <button 
                                onClick={() => {
                                    playSound('pop');
                                    setLessonStep('memorize_en');
                                }}
                                className="mt-12 w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-xl hover:bg-indigo-700 flex items-center justify-center gap-2 shadow-lg shadow-indigo-200"
                            >
                                Let's Learn! <ArrowRight />
                            </button>
                        </div>
                    )}

                    {/* 2. MEMORIZE ENGLISH */}
                    {lessonStep === 'memorize_en' && (
                        <MemorizeGame 
                            key={queueIndex}
                            text={currentWord.word_en}
                            lang="en"
                            image={currentWord.image}
                            onComplete={() => {
                                playSound('success');
                                setTimeout(() => {
                                    setLessonStep('spell_en');
                                }, 1000);
                            }}
                        />
                    )}

                    {/* 3. SPELL ENGLISH */}
                    {lessonStep === 'spell_en' && (
                        <div key={queueIndex} className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8">
                            <div className="text-6xl mb-6">{currentWord.image}</div>
                            <h3 className="text-xl font-bold text-gray-600 mb-8">Spell in English!</h3>
                            
                            <SpellingGame 
                                key={queueIndex}
                                targetText={currentWord.word_en}
                                lang="en"
                                onComplete={() => {
                                  setTimeout(() => setLessonStep('trace_en'), 1000);
                                }}
                            />
                        </div>
                    )}

                    {/* 4. TRACE ENGLISH */}
                    {lessonStep === 'trace_en' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8">
                            <TracingCanvas 
                                text={currentWord.word_en}
                                label="Trace English"
                                onComplete={() => {
                                    playSound('success');
                                    speak(currentWord.word_en); 
                                    setTimeout(() => {
                                      if (gameMode === 'english') {
                                          handleLessonComplete();
                                      } else {
                                          speak("Now in Hindi!", 'en-US');
                                          setLessonStep('memorize_hi');
                                      }
                                    }, 1200);
                                }}
                            />
                        </div>
                    )}

                    {/* 5. MEMORIZE HINDI (Dual Mode Only) */}
                    {lessonStep === 'memorize_hi' && (
                        <MemorizeGame 
                            key={queueIndex + '_hi'}
                            text={currentWord.word_hi}
                            lang="hi"
                            image={currentWord.image}
                            onComplete={() => {
                                playSound('success');
                                setTimeout(() => setLessonStep('spell_hi'), 1000);
                            }}
                        />
                    )}

                    {/* 6. SPELL HINDI */}
                    {lessonStep === 'spell_hi' && (
                        <div key={queueIndex + '_hi_spell'} className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8">
                            <div className="text-6xl mb-6">{currentWord.image}</div>
                            <h3 className="text-xl font-bold text-gray-600 mb-8">Spell in Hindi!</h3>
                            
                            <SpellingGame 
                                key={queueIndex + '_hi_spell'}
                                targetText={currentWord.word_hi}
                                lang="hi"
                                onComplete={() => {
                                   setTimeout(() => setLessonStep('trace_hi'), 1000);
                                }}
                            />
                        </div>
                    )}

                    {/* 7. TRACE HINDI */}
                    {lessonStep === 'trace_hi' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 animate-in fade-in slide-in-from-right-8">
                            <TracingCanvas 
                                text={currentWord.word_hi}
                                label="Trace Hindi"
                                onComplete={() => {
                                    playSound('success');
                                    speak(currentWord.word_hi, 'hi-IN'); 
                                    handleLessonComplete();
                                }}
                            />
                        </div>
                    )}
                    
                </div>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
  </body>
</html>